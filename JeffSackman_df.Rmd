---
title: "JeffSackman_df"
author: "Ben Moolman"
date: "2023-09-29"
output: html_document
---

```{r}
library(tidyverse)
library(readr)
library(deuce)
library(purrr)
```

Get csv for match data
```{r}
uso22 <- readr::read_csv("2022-usopen-points.csv")
```

Select one match from the data (Alcaraz def Sinner 6-3, 6-7, 6-7, 7-5, 6-3)
```{r}
# select the single match
usopen_2022_df <- uso22 |>
  filter(match_id == "2022-usopen-1503") |>
  # now use SetWinner variable to change P1GamesWon and P2GamesWon to 0 for these rows
  mutate(P1GamesWon = ifelse(SetWinner != 0, 0, P1GamesWon),
         P2GamesWon = ifelse(SetWinner != 0, 0, P2GamesWon))

# check to see if P1GamesWon and P2GamesWon are 0 for all rows where SetWinner != 0
usopen_2022_df |> filter(SetWinner != 0)
```

NOTE: Player 1 is Sinner and Player 2 is Alcaraz.
```{r}
test <- usopen_2022_df |> filter(P1GamesWon == 6 & P2GamesWon == 6)
```


Select the columns that we need, and alter the P1Score and P2Score variables using case_when
```{r}
uso_condensed <- usopen_2022_df |>
  select(PointWinner,
         P1Score,
         P2Score,
         P1GamesWon,
         P2GamesWon,
         SetWinner,
         PointServer) |>
  mutate(P1Score = ifelse(P1Score == "AD", 4, P1Score),
         P2Score = ifelse(P2Score == "AD", 4, P2Score),
         P1PointsWon = as.numeric(P1Score),
         P2PointsWon = as.numeric(P2Score)) |>
  mutate(P1PointsWon = case_when(P1Score == 0 ~ 0,
                                 P1Score == 15 ~ 1,
                                 P1Score == 30 ~ 2,
                                 P1Score == 40 ~ 3,
                                 TRUE ~ P1PointsWon),
         P2PointsWon = case_when(P2Score == 0 ~ 0,
                                 P2Score == 15 ~ 1,
                                 P2Score == 30 ~ 2,
                                 P2Score == 40 ~ 3,
                                 TRUE ~ P2PointsWon)) |>
  mutate(pt_number = row_number())
```


Make a data.frame with 8 columns, n_point rows, each column corresponds to an argument in the function above
```{r}
# make the dataframe
df <- tibble(
    p1_pts = uso_condensed$P1PointsWon,
    p2_pts = uso_condensed$P2PointsWon,
    p1_games = uso_condensed$P1GamesWon,
    p2_games = uso_condensed$P2GamesWon,
    p1_sets = cumsum(uso_condensed$SetWinner == 1),
    p2_sets = cumsum(uso_condensed$SetWinner == 2),
    server_prob = 0.52,
    returner_prob = 0.48,
    server = uso_condensed$PointServer,
    pt_number = uso_condensed$pt_number)
# split the df for each player serving
sinner_serving <- df |>
  filter(server == 1)
alcaraz_serving <- df |>
  filter(server == 2)
```

Sinner serving df
```{r}
# create df with sinner serving
sinner_serving_f <- tibble(
  point_a = sinner_serving$p1_pts,
  point_b = sinner_serving$p2_pts,
  game_a = sinner_serving$p1_games,
  game_b = sinner_serving$p2_games,
  set_a = sinner_serving$p1_sets,
  set_b = sinner_serving$p2_sets,
  server.prob = sinner_serving$server_prob,
  returner.prob = sinner_serving$returner_prob)
  
# calculate probability of sinner winning throughout the match
sinner_serve_prob <- sinner_serving_f |> pmap(in_match_win, bestof3 = FALSE,
                   advantage = FALSE)

# add probability to sinner_serving df
sinner_serving$probability <- sinner_serve_prob

# fix the probability column
sinner_serving <- sinner_serving |> unnest(probability)
```

Alcaraz serving df
```{r}
# create df with alcaraz serving
alcaraz_serving_f <- tibble(
  point_a = alcaraz_serving$p2_pts,
  point_b = alcaraz_serving$p1_pts,
  game_a = alcaraz_serving$p2_games,
  game_b = alcaraz_serving$p1_games,
  set_a = alcaraz_serving$p2_sets,
  set_b = alcaraz_serving$p1_sets,
  server.prob = alcaraz_serving$server_prob,
  returner.prob = alcaraz_serving$returner_prob)

# calculate probability of alcaraz winning throughout the match
alcaraz_serve_prob <- alcaraz_serving_f |> pmap(in_match_win, bestof3 = FALSE,
                   advantage = FALSE)

# add probability to alcaraz_serving df
alcaraz_serving$probability <- alcaraz_serve_prob

# fix the probability column
alcaraz_serving <- alcaraz_serving |> unnest(probability)
```

Combine the two data.frames
```{r}
# combine the two data.frames
recombined_uso <- rbind(sinner_serving, alcaraz_serving) |> 
  arrange(pt_number)
```

Plot the probability of winning the match for each player
```{r}
# change server variable to player name
recombined_uso$server <- ifelse(recombined_uso$server == 1, "Sinner", "Alcaraz")

# convert the server column to a factor
recombined_uso$server <- factor(recombined_uso$server)

library(ggplot2)

# plot the probability of winning the match for each player
recombined_uso |> ggplot(aes(x = pt_number, y = probability, color = server)) +
  geom_line() +
  scale_color_manual(values = c("red", "blue")) +
  labs(x = "Point Number",
       y = "Probability of Winning Match",
       title = "Alcaraz vs Sinner US Open 2022",
       subtitle = "Probability of Winning Match for Each Player",
       color = "Server") +
  theme_bw()
```

