---
title: "JeffSackman_df"
author: "Ben Moolman"
date: "2023-09-29"
output: html_document
---

```{r}
library(tidyverse)
library(readr)
library(deuce)
library(purrr)
```

Get csv for match data
```{r}
usopen_2022_df <- readr::read_csv("2022-usopen-points.csv")
```

Select one match from the data (Alcaraz def Sinner 6-3, 6-7, 6-7, 7-5, 6-3)
```{r}
# select the single match
usopen_2022_df <- usopen_2022_df |>
  filter(match_id == "2022-usopen-1503")
```

NOTE: Player 1 is Sinner and Player 2 is Alcaraz.

```{r}
test <- usopen_2022_df |> filter(P1GamesWon == 6 & P2GamesWon == 6)
```


Select the columns that we need, and alter the P1Score and P2Score variables using case_when
```{r}
uso_condensed <- usopen_2022_df |>
  select(PointWinner,
         P1Score,
         P2Score,
         P1GamesWon,
         P2GamesWon,
         SetWinner) |>
  mutate(P1Score = ifelse(P1Score == "AD", 4, P1Score),
         P2Score = ifelse(P2Score == "AD", 4, P2Score),
         P1PointsWon = as.numeric(P1Score),
         P2PointsWon = as.numeric(P2Score)) |>
  mutate(P1PointsWon = case_when(P1Score == 0 ~ 0,
                                 P1Score == 15 ~ 1,
                                 P1Score == 30 ~ 2,
                                 P1Score == 40 ~ 3,
                                 TRUE ~ P1PointsWon),
         P2PointsWon = case_when(P2Score == 0 ~ 0,
                                 P2Score == 15 ~ 1,
                                 P2Score == 30 ~ 2,
                                 P2Score == 40 ~ 3,
                                 TRUE ~ P2PointsWon))
```


Make a data.frame with 8 columns, n_point rows, each column corresponds to an argument in the function above
```{r}
# make the dataframe
df <- tibble(
    p1_pts = uso_condensed$P1PointsWon,
    p2_pts = uso_condensed$P2PointsWon,
    p1_games = uso_condensed$P1GamesWon,
    p2_games = uso_condensed$P2GamesWon,
    p1_sets = cumsum(uso_condensed$SetWinner == 1),
    p2_sets = cumsum(uso_condensed$SetWinner == 2),
    server_prob = 0.65,
    returner_prob = 0.55
  )
```


Put df into in_match_win(c(3), c(2), c(5), c(5),c(0), c(0), c(0.69), c(0.69), bestof3 = T, advantage = F)

Having trouble with tiebreaker, filter to see those points

```{r}
test <- df |> filter(p1_games == 6 & p2_games == 6)
```

```{r}
# try passing in as lists?
p1_pts_list <- list(df$p1_pts)
p2_pts_list <- list(df$p2_pts)
p1_games_list <- list(df$p1_games)
p2_games_list <- list(df$p2_games)
p1_sets_list <- list(df$p1_sets)
p2_sets_list <- list(df$p2_sets)
server_prob_list <- list(df$server_prob)
returner_prob_list <- list(df$returner_prob)
in_match_win(p1_pts_list, p2_pts_list, p1_games_list, p2_games_list, p1_sets_list, p2_sets_list, server_prob_list, returner_prob_list, bestof3 = F, advantage = F)

toy_points <- tibble::tibble(point_a = p1_pts_list, point_b = p2_pts_list,
                         game_a = p1_games_list, game_b = p2_games_list,
                         set_a = p1_sets_list, set_b = p2_sets_list,
                         server.prob = server_prob_list,
                         returner.prob = returner_prob_list)


pmap(toy_points, in_match_win, bestof3 = FALSE,
                   advantage = TRUE)
```

2. Look at purrr_toy.R and apply iteration to obtain probabilities over an entire match.
```{r}
# make a toy dataframe
toy_df <- tibble(
  point_a = c(0, 0, 0, 0, 0, 1, 2, 3, 0),
  point_b = c(0, 1, 2, 3, 0, 0, 0, 0, 0),
  game_a = c(0, 0, 0, 1, 1, 1, 1, 1, 1),
  game_b = c(0, 0, 0, 0, 0, 0, 0, 0, 1),
  set_a = c(0, 0, 0, 0, 0, 0, 0, 0, 0),
  set_b = c(0, 0, 0, 0, 0, 0, 0, 0, 0),
  server.prob = c(0.65, 0.65, 0.65, 0.65, 0.65, 0.65, 0.65, 0.65, 0.65),
  returner.prob = c(0.55, 0.55, 0.55, 0.55, 0.55, 0.55, 0.55, 0.55, 0.55))

toy_df |> pmap(in_match_win, bestof3 = FALSE,
                   advantage = TRUE)
```

```{r}
p1_pts_tuple <- tibble(p1_pts = I(list(df$p1_pts)))
p2_pts_tuple <- tibble(p2_pts = I(list(df$p2_pts)))
p1_games_tuple <- tibble(p1_games = I(list(df$p1_games)))
p2_games_tuple <- tibble(p2_games = I(list(df$p2_games)))
p1_sets_tuple <- tibble(p1_sets = I(list(df$p1_sets)))
p2_sets_tuple <- tibble(p2_sets = I(list(df$p2_sets)))
server_prob_tuple <- tibble(server_prob = I(list(df$server_prob)))
returner_prob_tuple <- tibble(returner_prob = I(list(df$returner_prob)))

toy_df2 <- tibble(
  point_a = p1_pts_tuple,
  point_b = p2_pts_tuple,
  game_a = p1_games_tuple,
  game_b = p2_games_tuple,
  set_a = p1_sets_tuple,
  set_b = p2_sets_tuple,
  server.prob = server_prob_tuple,
  returner.prob = returner_prob_tuple)

toy_df2 |> pmap(in_match_win, bestof3 = FALSE,
                   advantage = TRUE)
```

```{r}
# passing in as vectors?
p1_pts_vector <- df$p1_pts
p2_pts_vector <- df$p2_pts
p1_games_vector <- df$p1_games
p2_games_vector <- df$p2_games
p1_sets_vector <- df$p1_sets
p2_sets_vector <- df$p2_sets
server_prob_vector <- df$server_prob
returner_prob_vector <- df$returner_prob

toy_df3 <- tibble(
  point_a = p1_pts_vector,
  point_b = p2_pts_vector,
  game_a = p1_games_vector,
  game_b = p2_games_vector,
  set_a = p1_sets_vector,
  set_b = p2_sets_vector,
  server.prob = server_prob_vector,
  returner.prob = returner_prob_vector)

toy_df3 |> pmap(in_match_win, bestof3 = FALSE,
                   advantage = TRUE)
```



