<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Estimating Tennis In-Match-Win Probability with Bayesian Modeling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Project_Write_Up_files/libs/clipboard/clipboard.min.js"></script>
<script src="Project_Write_Up_files/libs/quarto-html/quarto.js"></script>
<script src="Project_Write_Up_files/libs/quarto-html/popper.min.js"></script>
<script src="Project_Write_Up_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Project_Write_Up_files/libs/quarto-html/anchor.min.js"></script>
<link href="Project_Write_Up_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Project_Write_Up_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Project_Write_Up_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Project_Write_Up_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Project_Write_Up_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="Project_Write_Up_files/libs/kePrint-0.0.1/kePrint.js"></script>
<link href="Project_Write_Up_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#atp-and-wta-professional-tennis-calculating-in-match-win-probability-with-bayesian-modeling" id="toc-atp-and-wta-professional-tennis-calculating-in-match-win-probability-with-bayesian-modeling" class="nav-link" data-scroll-target="#atp-and-wta-professional-tennis-calculating-in-match-win-probability-with-bayesian-modeling">ATP and WTA Professional Tennis: Calculating In-Match-Win Probability with Bayesian Modeling</a></li>
  <li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a></li>
  <li><a href="#tennis-scoring" id="toc-tennis-scoring" class="nav-link" data-scroll-target="#tennis-scoring">Tennis Scoring</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  </ul></li>
  <li><a href="#bayesian-modeling" id="toc-bayesian-modeling" class="nav-link" data-scroll-target="#bayesian-modeling">Bayesian Modeling</a>
  <ul class="collapse">
  <li><a href="#brief-overview" id="toc-brief-overview" class="nav-link" data-scroll-target="#brief-overview">Brief Overview</a></li>
  <li><a href="#matches-for-prior-distributions" id="toc-matches-for-prior-distributions" class="nav-link" data-scroll-target="#matches-for-prior-distributions">Matches for Prior Distributions</a></li>
  <li><a href="#paired-competition-model" id="toc-paired-competition-model" class="nav-link" data-scroll-target="#paired-competition-model">Paired Competition Model</a></li>
  <li><a href="#calculating-the-prior-distributions-of-the-probabilities-that-alcaraz-and-sinner-win-a-point-on-serve" id="toc-calculating-the-prior-distributions-of-the-probabilities-that-alcaraz-and-sinner-win-a-point-on-serve" class="nav-link" data-scroll-target="#calculating-the-prior-distributions-of-the-probabilities-that-alcaraz-and-sinner-win-a-point-on-serve">Calculating the Prior Distributions of the Probabilities that Alcaraz and Sinner Win a Point on Serve</a></li>
  <li><a href="#prior-data-and-posterior" id="toc-prior-data-and-posterior" class="nav-link" data-scroll-target="#prior-data-and-posterior">Prior, Data and Posterior</a></li>
  <li><a href="#moving-forward" id="toc-moving-forward" class="nav-link" data-scroll-target="#moving-forward">Moving Forward</a></li>
  </ul></li>
  <li><a href="#caclulating-in-match-win-probability-alcaraz-vs-sinner-case-study-1" id="toc-caclulating-in-match-win-probability-alcaraz-vs-sinner-case-study-1" class="nav-link" data-scroll-target="#caclulating-in-match-win-probability-alcaraz-vs-sinner-case-study-1">Caclulating In-Match-Win Probability (Alcaraz vs Sinner, Case Study 1)</a></li>
  <li><a href="#changing-prior-distributions-alcaraz-vs-sinner" id="toc-changing-prior-distributions-alcaraz-vs-sinner" class="nav-link" data-scroll-target="#changing-prior-distributions-alcaraz-vs-sinner">Changing Prior Distributions (Alcaraz vs Sinner)</a></li>
  <li><a href="#caclulating-in-match-win-probability-gauff-vs-sabalenka-case-study-2" id="toc-caclulating-in-match-win-probability-gauff-vs-sabalenka-case-study-2" class="nav-link" data-scroll-target="#caclulating-in-match-win-probability-gauff-vs-sabalenka-case-study-2">Caclulating In-Match-Win Probability (Gauff vs Sabalenka, Case Study 2)</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements">Acknowledgements</a></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a>
  <ul class="collapse">
  <li><a href="#reading-in-match-data" id="toc-reading-in-match-data" class="nav-link" data-scroll-target="#reading-in-match-data">Reading in Match data</a></li>
  <li><a href="#creating-prior-distributions" id="toc-creating-prior-distributions" class="nav-link" data-scroll-target="#creating-prior-distributions">Creating Prior Distributions</a></li>
  <li><a href="#reading-in-point-by-point-data" id="toc-reading-in-point-by-point-data" class="nav-link" data-scroll-target="#reading-in-point-by-point-data">Reading in Point-by-Point data</a></li>
  <li><a href="#getting-probabilities-of-winning-point-on-serve-throughout-the-match" id="toc-getting-probabilities-of-winning-point-on-serve-throughout-the-match" class="nav-link" data-scroll-target="#getting-probabilities-of-winning-point-on-serve-throughout-the-match">Getting Probabilities of Winning Point on Serve Throughout the Match</a></li>
  <li><a href="#getting-data-frame-for-plotting-win-probabilities" id="toc-getting-data-frame-for-plotting-win-probabilities" class="nav-link" data-scroll-target="#getting-data-frame-for-plotting-win-probabilities">Getting Data Frame for Plotting Win Probabilities</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Estimating Tennis In-Match-Win Probability with Bayesian Modeling</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>– TODO fix messages below –</p>
<p>BM: I can’t get the messages to shut up for this (in Prior, Data and Posterior section):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use a bayesian generalized linear model to update our prior distribution</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(server_won <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> p1_serving <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>p1_niter),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> binomial,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(prior_sin_logodds, prior_sin_sd_logodds),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>– TODO revise paragraph talking about mean vs distribution (lines 526-534) –</p>
<p>or search “TODO” and it should pop up</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<section id="atp-and-wta-professional-tennis-calculating-in-match-win-probability-with-bayesian-modeling" class="level3">
<h3 class="anchored" data-anchor-id="atp-and-wta-professional-tennis-calculating-in-match-win-probability-with-bayesian-modeling">ATP and WTA Professional Tennis: Calculating In-Match-Win Probability with Bayesian Modeling</h3>
<p>In this project, we explore the in-match-win probability of professional tennis matches. Tennis’ scoring format allows for huge momentum swings in a short amount of time. We are going to explore how the probabilities that tennis players win a match are calculated and update throughout the match using Bayesian modeling. To determine the probability that a player (player 1) wins a match against another player (player 2), we incorporate (1) the probability that player 1 wins a point on serve against player 2, (2) the probability that player 2 wins a point on serve against player 1, and (3) the current score of the match of interest. The prior distributions for (1) and (2) are generated from points played in matches prior to the match of interest. Both (1) and (2) are then updated throughout the match of interest as points played between the two players update their prior point-win probabilities. As case studies, we explore the 2022 Men’s US Open Quarterfinal between Carlos Alcaraz and Jannik Sinner and the 2023 Women’s US Open Final between Coco Gauff and Arnya Sabalenka.</p>
</section>
<section id="outline" class="level3">
<h3 class="anchored" data-anchor-id="outline">Outline</h3>
<p>We begin by exploring tennis scoring to get an understanding of how a match is played. We then look at the data we are using in this project. From there we discuss Bayesian modeling, and come up with our probabilities of the players winning a point on their serves against specific opponents. We calculate the in-match-win probability and how we update our prior distributions throughout the match. We then look at the case studies of the 2022 Men’s US Open Quarterfinal between Carlos Alcaraz and Jannik Sinner, and discuss how we can change what matches we include in our prior distribution. We also explore the 2023 Women’s US Open Final between Coco Gauff and Aryna Sabalenka. We conclude with a discussion of the results and potential future work. An appendix is included with the code used in this project for reference.</p>
</section>
<section id="tennis-scoring" class="level3">
<h3 class="anchored" data-anchor-id="tennis-scoring">Tennis Scoring</h3>
<p>The scoring format in tennis can be confusing to those that are not familiar with the sport.</p>
<ul>
<li>The match starts with one player serving at 0-0</li>
<li>The server is the player that hits the ball first in a point</li>
<li>The server alternates what direction they serve from after every point (deuce side and ad side)</li>
<li>A game is played with the server serving for the entire game</li>
<li>A game is won by the first player to win 4 points, wining by a margin of 2 or more points</li>
<li>Sets are played first to 6 games, wining by a margin of 2 or more games</li>
<li>If the score reaches 6-6 in a set, a tiebreak is played</li>
<li>A tiebreak is won by the first player to win 7 points, wining by a margin of 2 or more points</li>
<li>A match is played to the best of 3 or 5 sets based on the tournament format</li>
</ul>
<p>A little more tennis terminology are the words break and hold.</p>
<ul>
<li>Break: when the player returning wins the game</li>
<li>Hold: when the player serving wins the game</li>
</ul>
<p>A graphic is attached below to help, and a more detailed write-up can be found on the website <em>doubletake</em> <a href="https://www.shopdoubletake.com/blogs/well-played/tennis-scoring-101">here</a>.</p>
<p><img src="tennis_scoring.jpeg" class="img-fluid"></p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>The data used in this project is from the ATP and WTA professional tennis tours, and is from Jeff Sackman’s tennis data on Github. There is <a href="https://github.com/JeffSackmann/tennis_slam_pointbypoint">point-level data</a> on the ATP and WTA main-draw singles grand slam tournaments from 2011-present. There is also <a href="https://github.com/JeffSackmann/tennis_atp">match-level data</a> for ATP matches and <a href="https://github.com/JeffSackmann/tennis_wta">match-level data</a> for WTA matches. Access to the data is needed to ensure correct spelling of player names (especially nicknames, ie “Rafa Nadal” vs “Rafael Nadal”) and tournament names, the correct date ranges, file paths, and match IDs for specific matches of interest. Checking these details is best done on the matches data frames, and if finding the information on the Github site is problematic, the data can be read in using the <code>read_matches()</code> function, which works for both ATP and WTA data.</p>
<p>We can explore what the data containing all of the matches looks like. Here we look at one match from the first round of the 2022 Men’s US Open. This is one row of the data frame but is shown over multiple rows here for readability.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">winner_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">loser_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">tourney_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">tourney_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">surface</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">draw_size</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">tourney_level</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tourney_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Daniil Medvedev</td>
<td style="text-align: left;">Stefan Kozlov</td>
<td style="text-align: left;">2022-560</td>
<td style="text-align: left;">Us Open</td>
<td style="text-align: left;">Hard</td>
<td style="text-align: right;">128</td>
<td style="text-align: left;">G</td>
<td style="text-align: right;">20220829</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">match_num</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">winner_id</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">winner_seed</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">winner_entry</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">winner_hand</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">winner_ht</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">winner_ioc</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">winner_age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">100</td>
<td style="text-align: right;">106421</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">R</td>
<td style="text-align: right;">198</td>
<td style="text-align: left;">RUS</td>
<td style="text-align: right;">26.5</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">loser_id</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">loser_seed</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">loser_entry</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">loser_hand</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">loser_ht</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">loser_ioc</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">loser_age</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">111578</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">R</td>
<td style="text-align: right;">183</td>
<td style="text-align: left;">USA</td>
<td style="text-align: right;">24.5</td>
<td style="text-align: left;">6-2 6-4 6-0</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">best_of</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">round</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">minutes</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_ace</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_df</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_svpt</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_1stIn</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_1stWon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">R128</td>
<td style="text-align: right;">121</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">28</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">w_2ndWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_SvGms</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_bpSaved</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">w_bpFaced</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_ace</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_df</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_svpt</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_1stIn</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_1stWon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">19</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">77</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">25</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">l_2ndWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_SvGms</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_bpSaved</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">l_bpFaced</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">winner_rank</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">winner_rank_points</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">loser_rank</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">loser_rank_points</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6885</td>
<td style="text-align: right;">111</td>
<td style="text-align: right;">493</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>We can explore some of the point level data to get a better understanding of what we are working with. Below are some selected rows from the point-level data once we have cleaned it and tidied it for what we need. This data is taken from the 2022 Men’s US Open Quarterfinal between Carlos Alcaraz and Jannik Sinner.</p>
<p>Here are the first 10 points from the start of the match, where we see Alcaraz break Sinner’s serve in the first game of the match:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">pt_number</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PointServer</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PointWinner</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">P1Score</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">P2Score</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P1GamesWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P2GamesWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P1SetsWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P2Setswon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">15</td>
<td style="text-align: left;">15</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">15</td>
<td style="text-align: left;">30</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">30</td>
<td style="text-align: left;">30</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">30</td>
<td style="text-align: left;">40</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">40</td>
<td style="text-align: left;">40</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">40</td>
<td style="text-align: left;">AD</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">40</td>
<td style="text-align: left;">40</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">40</td>
<td style="text-align: left;">AD</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
<p>Here are some points at the end of the second set, as Sinner wins the second set tiebreak 9-7:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<table class="table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">pt_number</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PointServer</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">PointWinner</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">P1Score</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">P2Score</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P1GamesWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P2GamesWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P1SetsWon</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">P2Setswon</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">143</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">144</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">145</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">146</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">147</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">2</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">148</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">3</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">149</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">3</td>
<td style="text-align: left;">3</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">150</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">4</td>
<td style="text-align: left;">3</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">151</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">3</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">152</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">4</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">153</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">5</td>
<td style="text-align: left;">5</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">154</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">5</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">155</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">156</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">6</td>
<td style="text-align: left;">7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">157</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">7</td>
<td style="text-align: left;">7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">158</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">8</td>
<td style="text-align: left;">7</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">159</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">160</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">15</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">161</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">30</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">162</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">40</td>
<td style="text-align: left;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</section>
</section>
<section id="bayesian-modeling" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-modeling">Bayesian Modeling</h2>
<section id="brief-overview" class="level3">
<h3 class="anchored" data-anchor-id="brief-overview">Brief Overview</h3>
<p>In Bayesian modeling, we start with some existing beliefs about a parameter, which we call our prior distribution. We then observe new data come in and update our beliefs about the parameter based on the new data, which we call our posterior distribution.</p>
<p>In this project, our parameters of interest are the probabilities that player1 and player2 win a point on their serve. We calculate these probabilities using previous matches that have been played. As the match progresses, we update our beliefs about these probabilities of winning a point on serve, and at a specific state of the match, we can calculate the probability that either of the players wins the match. Choosing what matches we include in our prior distributions is important, as we want to include matches that are relevant to the match of interest.</p>
<p>Throughout this paper, we use the 2022 Men’s US Open Quarterfinal match between Carlos Alcaraz and Jannik Sinner as an example match to make discussing the Bayesian model more straightforward. So, in the context of this match, our parameters of interest are the probabilities that Alcaraz wins a point on his serve against Sinner, and the probability that Sinner wins a point on his serve against Alcaraz. After each point of the match is played, we update these probabilities.</p>
</section>
<section id="matches-for-prior-distributions" class="level3">
<h3 class="anchored" data-anchor-id="matches-for-prior-distributions">Matches for Prior Distributions</h3>
<p>We start with some prior beliefs about the probabilities that Alcaraz and Sinner win a point on serve. We use the data from previous matches to calculate these prior distributions. These matches we choose to include in our prior distributions are important, as we want to include matches that are relevant to the match of interest. The matches we include are matches that Alcaraz and Sinner have played in, as well as matches that other players have played in. This is because we want to include matches that have some connection between Alcaraz and Sinner, even if they have not played against each other.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project_Write_Up_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This network diagram is an example of a group of matches that can be used to form a prior distribution. Note that this is not the actual prior distribution that we use later, but is a made-up prior distribution to help visualize.</p>
<p>In the diagram, the nodes represent players, and the edges represent matches that have been played. We can see that Jannik Sinner and Carlos Alcaraz have not played a match against each other out of the matches included here. We are able to calculate their probabilities of winning a point on serve against each other by using the data from the matches that they have played in, as well as the matches that other players have played in, because there is a connection between them.</p>
<p>For example, we would not be able to use just the early rounds of the 2022 US Open to form a prior distribution for the quarterfinal matchup between Alcaraz and Sinner. This is because there is no connection between the two players in the early rounds of the tournament, as nobody in Alcaraz’s section of the draw has played anyone in Sinner’s section of the draw. We would need to include matches that have a connection between Alcaraz and Sinner, even if they have not played against each other.</p>
</section>
<section id="paired-competition-model" class="level3">
<h3 class="anchored" data-anchor-id="paired-competition-model">Paired Competition Model</h3>
<p>When forming our prior beliefs, we are using a paired competition model. This means that we are using data from the matches that Alcaraz and Sinner have played in, as well as other players that they have played against. For this to work, we need there to be some connection between Alcaraz and Sinner using matches they and other opponents have played (ie Sinner has played against playera, who played against playerb, who played against Alcaraz).</p>
<p>We define <span class="math inline">\(Y_{ijk}\)</span> to be a Bernoulli random variable equal to either: * <span class="math inline">\(1\)</span> if player <span class="math inline">\(i\)</span> wins the <span class="math inline">\(k^{th}\)</span> point against player <span class="math inline">\(j\)</span> * <span class="math inline">\(0\)</span> if player <span class="math inline">\(i\)</span> loses the <span class="math inline">\(k^{th}\)</span> point against player <span class="math inline">\(j\)</span></p>
<p>Then <span class="math inline">\(\text{E}(Y_{ijk}) \equiv \pi_{ijk}\)</span>, the probability that Player <span class="math inline">\(i\)</span> wins the <span class="math inline">\(k^{th}\)</span> point against Player <span class="math inline">\(j\)</span>.</p>
<p>So for calculating this in regards to Alcaraz and Sinner and all matches we include in the prior we have: <span class="math display">\[\text{logit}(\pi_{ijk}) = \beta_{alcaraz}X_{alcaraz} + \beta_{sinner}X_{sinner} + \ldots + \beta_{ruud}X_{ruud}\]</span> Where <span class="math inline">\(X_{alcaraz}\)</span> is equal to: * <span class="math inline">\(1\)</span> if Alcaraz is player <span class="math inline">\(i\)</span> on the <span class="math inline">\(k^{th}\)</span> point * <span class="math inline">\(0\)</span> if Alcaraz is neither player <span class="math inline">\(i\)</span> nor player <span class="math inline">\(j\)</span> on the <span class="math inline">\(k^{th}\)</span> point * <span class="math inline">\(-1\)</span> if Alcaraz is player <span class="math inline">\(j\)</span> on the <span class="math inline">\(k^{th}\)</span> point</p>
<p>and <span class="math inline">\(\beta_{alcaraz}\)</span> represents a unitless “ability” of Alcaraz.</p>
<p>For an example, the log-odds of Carlos Alcaraz (player <span class="math inline">\(i\)</span>) winning a point against Jannik Sinner (player <span class="math inline">\(j\)</span>):</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    \text{logit}(\pi_{ij}) &amp; = \beta_{alcaraz}(1) + \beta_{sinner}(-1) + \ldots + \beta_{ruud}(0) \\
                                 &amp; = \beta_{alcaraz} - \beta_{sinner}
  \end{aligned}
\end{equation}\]</span></p>
<p>We can then work on adding a serving effect:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    \text{logit}(\pi_{ijk}) = &amp; \beta_{alcaraz}X_{alcaraz} + \beta_{sinner}X_{sinner} + \ldots + \beta_{ruud}X_{ruud} + \\
    &amp; \alpha_{alcaraz}X_{alcaraz,s} + \alpha_{sinner}X_{sinner,s} + \ldots + \alpha_{ruud}X_{ruud,s}
  \end{aligned}
\end{equation}\]</span></p>
<p>Where <span class="math inline">\(X_{alcaraz,s}\)</span> is equal to: * <span class="math inline">\(1\)</span> if Alcaraz is the serving player <span class="math inline">\(i\)</span> on point <span class="math inline">\(k\)</span>. * <span class="math inline">\(0\)</span> if Alcaraz is the returning player on point <span class="math inline">\(k\)</span> or if Alcaraz is neither player <span class="math inline">\(i\)</span> nor player <span class="math inline">\(j\)</span>. * <span class="math inline">\(-1\)</span> if Alcaraz is the serving player <span class="math inline">\(j\)</span> on point <span class="math inline">\(k\)</span></p>
<p>And so we have <span class="math inline">\(\alpha_{alcaraz}\)</span> representing a bump in point win probability for when Alcaraz serves compared to when he receives.</p>
<p>So as an example, the log-odds of Carlos Alcaraz (player <span class="math inline">\(i\)</span>) winning a point against Jannik Sinner (player <span class="math inline">\(j\)</span>) with Alcaraz serving on point <span class="math inline">\(k\)</span> would be:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    \text{logit}(\pi_{ijk}) &amp; = \beta_{alcaraz}(1) +       \beta_{sinner}(-1) + \ldots + \beta_{ruud}(0) + \\
    &amp; \;\;\;\; \alpha_{alcaraz}(1) + \alpha_{sinner}(0) + \ldots + \alpha_{ruud}(0) \\
    &amp; = \beta_{alcaraz} + \alpha_{alcaraz} - \beta_{sinner}
  \end{aligned}
\end{equation}\]</span></p>
<p>And as another example, the log-odds of Carlos Alcaraz (player <span class="math inline">\(i\)</span>) winning a point against Jannik Sinner (player <span class="math inline">\(j\)</span>) with Sinner serving on point <span class="math inline">\(k\)</span> would be:</p>
<p><span class="math display">\[\begin{equation}
  \begin{aligned}
    \text{logit}(\pi_{ijk}) &amp; = \beta_{alcaraz}(1) +       \beta_{sinner}(-1) + \ldots + \beta_{ruud}(0) + \\
    &amp; \;\;\;\; \alpha_{alcaraz}(0) + \alpha_{sinner}(-1) + \ldots + \alpha_{ruud}(0) \\
    &amp; = \beta_{alcaraz} - \beta_{sinner} - \alpha_{sinner}
  \end{aligned}
\end{equation}\]</span></p>
<p>We use the data from the leadup tournaments to the 2022 US Open (hard court tournaments) and the rounds of the 2022 US Open before the quarterfinals to calculate these coefficients in the paired competition model. We can then calculate the probability that Alcaraz wins a point while serving against Sinner, and the probability that Sinner wins a point while serving against Alcaraz. With these estimated probabilities and standard deviations, we then create distributions for the prior probabilities of winning a point on serve for Alcaraz and Sinner.</p>
</section>
<section id="calculating-the-prior-distributions-of-the-probabilities-that-alcaraz-and-sinner-win-a-point-on-serve" class="level3">
<h3 class="anchored" data-anchor-id="calculating-the-prior-distributions-of-the-probabilities-that-alcaraz-and-sinner-win-a-point-on-serve">Calculating the Prior Distributions of the Probabilities that Alcaraz and Sinner Win a Point on Serve</h3>
<p>Load in libraries and source in functions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># install James Wolpe's compr package, run below in console</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github(repo = "https://github.com/jameswolpe/compr")</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(compr)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># install skoval's deuce package, run below in console</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("skoval/deuce")</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(deuce)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"comp_prior_start.R"</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"bayes_intro.R"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"wrangle_point_level_data.R"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"create_prior.R"</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"get_probabilities_df.R"</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"get_plot_df.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To calculate the prior distributions of the probabilities that Alcaraz and Sinner win a point on serve, we use our <code>create_prior()</code> function. Note that this function’s outputs are on the log-odds scale, and contains the mean log-odds values and standard deviations, and are also all in reference to <code>player1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>aug_mod_sin_small_prior <span class="ot">&lt;-</span> <span class="fu">create_prior</span>(<span class="at">ext =</span> <span class="fu">c</span>(<span class="st">"atp_matches_2022.csv"</span>),</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tourn_name =</span> <span class="st">"Us Open"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">surf =</span> <span class="st">"Hard"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">start_date =</span> <span class="st">"2022-07-25"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">end_date =</span> <span class="st">"2022-09-06"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player2 =</span> <span class="st">"Carlos Alcaraz"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ref_player =</span> <span class="st">"Daniil Medvedev"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>aug_mod_sin_small_prior <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 20%">
<col style="width: 21%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 15%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">player1</th>
<th style="text-align: left;">player2</th>
<th style="text-align: right;">p1_server</th>
<th style="text-align: right;">p2_server</th>
<th style="text-align: right;">.fitted</th>
<th style="text-align: right;">.se.fit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Jannik Sinner</td>
<td style="text-align: left;">Carlos Alcaraz</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.2434863</td>
<td style="text-align: right;">0.1193404</td>
</tr>
<tr class="even">
<td style="text-align: left;">Jannik Sinner</td>
<td style="text-align: left;">Carlos Alcaraz</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.5017383</td>
<td style="text-align: right;">0.1196950</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>From the output, we see that Sinner has a mean value of winning a point while serving against Alcaraz of <code>0.2434863</code> with a standard error of <code>0.1193404</code>, and both of these are on the log-odds scale. This is indicated by <code>p1_server</code> being equal to <code>1</code> for this row. We can also see that Sinner has a mean value of winning a point while returning against Alcaraz of <code>-0.5017383</code> with a standard error of <code>0.1196950</code>, and again both on the log-odds scale. To get the log-odds of Alcaraz winning a point while serving against Sinner, we can negate the value of Sinner winning a point while returning against Alcaraz. We can then convert these from the log-odds scale to probabilities of winning a point on serve using the logistic function <code>expit()</code>. The logistic function transforms the log-odds to probabilities, ensuring that the probabilities fall within the range [0, 1].</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Sinner wins a point on serve</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fl">0.2434863</span>) <span class="co"># 0.5605726</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5605726</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Sinner wins a point on return</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="sc">-</span><span class="fl">0.5017383</span>) <span class="co">#  0.3771322</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3771322</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Alcaraz wins a point on serve</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fl">0.5017383</span>) <span class="co"># 0.6228678</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6228678</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Alcaraz wins a point on return</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="sc">-</span><span class="fl">0.2434863</span>) <span class="co"># 0.4394274</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4394274</code></pre>
</div>
</div>
<p>From this prior we have created, we are estimating Sinner to win around 56.06% of points played on his serve against Alcaraz, and for Alcaraz to win around 62.29% of points played on his serve against Sinner.</p>
<p>We can then create distributions to visualize what these probabilities look like. We’ll start with our log-odds and randomly generate 200,000 random samples from a normal distribution with mean log-odds from our prior and standard deviations from our prior.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save sinner log-odds and sd from prior as variables</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>prior_sin_logodds <span class="ot">&lt;-</span> <span class="fl">0.2434863</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>prior_sin_sd_logodds <span class="ot">&lt;-</span> <span class="fl">0.1193404</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># generate random samples from normal distribution</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>prior_sin_df <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">logodds =</span> <span class="fu">rnorm</span>(<span class="dv">200000</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                                                 prior_sin_logodds,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                                                 prior_sin_sd_logodds),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">prob =</span> <span class="fu">expit</span>(logodds))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save alcaraz log-odds and sd from prior as variables</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>prior_alc_logodds <span class="ot">&lt;-</span> <span class="fl">0.5017383</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>prior_alc_sd_logodds <span class="ot">&lt;-</span> <span class="fl">0.1196950</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># generate random samples from normal distribution</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>prior_alc_df <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">logodds =</span> <span class="fu">rnorm</span>(<span class="dv">200000</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                                                 prior_alc_logodds,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                                                 prior_alc_sd_logodds),</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                           <span class="at">prob =</span> <span class="fu">expit</span>(logodds))</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the two dfs and distinguish them by type</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>both_priors_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(prior_sin_df, prior_alc_df, <span class="at">.id =</span> <span class="st">"type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">fct_recode</span>(type, <span class="st">"Sinner"</span> <span class="ot">=</span> <span class="st">"1"</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"Alcaraz"</span> <span class="ot">=</span> <span class="st">"2"</span>),</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> <span class="fu">fct_relevel</span>(type, <span class="fu">c</span>(<span class="st">"Sinner"</span>, <span class="st">"Alcaraz"</span>)))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the two prior distributions</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> both_priors_df, <span class="fu">aes</span>(<span class="at">x =</span> prob)) <span class="sc">+</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">colour =</span> type), <span class="at">adjust =</span> <span class="dv">2</span>, </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">1.4</span>) <span class="sc">+</span> <span class="do">## adjust smooths it out</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_viridis_d</span>(<span class="at">end =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prior Distributions for Sinner and Alcaraz"</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Probability of Winning a Point (on serve)"</span>,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Prior includes matches from leadup tournaments to 2022 USO and 2022 USO itself"</span>) <span class="sc">+</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project_Write_Up_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From our prior distributions, we can see that Sinner’s probability of winning a point on serve against Alcaraz is around 0.57, and Alcaraz’s probability of winning a point on serve against Sinner is around 0.62. These are our starting probability distributions for the match. Based on their prior matches we have included, we think that Alcaraz has a higher probability of winning a point on his serve than Sinner does, but, there is some overlap in their prior distributions. As each point is played, we update these probability distributions.</p>
</section>
<section id="prior-data-and-posterior" class="level3">
<h3 class="anchored" data-anchor-id="prior-data-and-posterior">Prior, Data and Posterior</h3>
<p>Now with our prior distributions for the probabilities that the players win a point while serving, we can observe how these probabilities update throughout the match by looking at a specific state of the match.</p>
<p>But first, we need to load in our data for the match between Alcaraz and Sinner. To do this, we use our function <code>wrangle_point_level()</code>. This function returns a list of two data frames, and the order is determined by which player is listed as Player1 and Player2 for the match, and this can be found on <a href="https://github.com/JeffSackmann">Jeff Sackman’s Github</a>. Look at either the <code>tennis_atp</code> repo or the <code>tennis_wta</code> repo, find the csv with the correct match year for the match of interest, and from this find the correct match-ID to use in the function. Also make sure to determine which player is Player1 and Player2. If the Github repo code is not easy to read, you can also load in the csv file with the <code>read_matches()</code> function, as noted earlier, and find the correct match-ID from there:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>atp_matches_2022 <span class="ot">&lt;-</span> <span class="fu">read_matches</span>(<span class="st">"atp_matches_2022.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have our match-ID, we can load in the data for the match between Alcaraz and Sinner:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># returns list of two data frames</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>sin_alc_paired <span class="ot">&lt;-</span> <span class="fu">wrangle_point_level</span>(<span class="at">ext =</span> <span class="st">"2022-usopen-points.csv"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ID =</span> <span class="st">"2022-usopen-1503"</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># first data frame corresponds to player1 (Sinner)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>sin_serving <span class="ot">&lt;-</span> sin_alc_paired[[<span class="dv">1</span>]]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># sescond data frame corresponds to player2 (Alcaraz)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>alc_serving <span class="ot">&lt;-</span> sin_alc_paired[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can look at a specific state of the match now that we have our data. For our Alcaraz and Sinner example, we also have their probabilities of winning a point on serve at the very start of the match. We can look at Sinner when he is serving at 40-15, 1-1 in the 3rd set (a little less than halfway through the match) and see how his probability of winning a point on serve has changed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>p1_serving_df <span class="ot">&lt;-</span> sin_serving <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">150</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>p1_serving_df <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">points_won =</span> <span class="fu">sum</span>(PointWinner <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">points_played =</span> <span class="fu">n</span>(),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">prop_won =</span> points_won <span class="sc">/</span> points_played) <span class="sc">|&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">points_won</th>
<th style="text-align: right;">points_played</th>
<th style="text-align: right;">prop_won</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">89</td>
<td style="text-align: right;">150</td>
<td style="text-align: right;">0.5933333</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>At this state of the match, Sinner has played 150 points on his serve and won 89 of them, which is right around 0.6. We’d expect his updated distribution to shift towards 0.6, as his original probability was around 0.5606.</p>
<p>Now let’s plot Sinner’s prior distribution with his updated prior distribution at this specific state of the match.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the number of rows in the data frame</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>p1_niter <span class="ot">&lt;-</span> p1_serving_df <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a storage vector for the probabilities</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>p1_prob_store <span class="ot">&lt;-</span> <span class="fu">double</span>()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create indicator if serving player won the point</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>p1_serving <span class="ot">&lt;-</span> p1_serving_df <span class="sc">|&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">server_won =</span> <span class="fu">ifelse</span>(PointWinner <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use a bayesian generalized linear model to update our prior distribution</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(server_won <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> p1_serving <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>p1_niter),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> binomial,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(prior_sin_logodds, prior_sin_sd_logodds),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed =</span> <span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
SAMPLING FOR MODEL 'bernoulli' NOW (CHAIN 1).
Chain 1: 
Chain 1: Gradient evaluation took 1.9e-05 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.19 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 0.04 seconds (Warm-up)
Chain 1:                0.045 seconds (Sampling)
Chain 1:                0.085 seconds (Total)
Chain 1: 

SAMPLING FOR MODEL 'bernoulli' NOW (CHAIN 2).
Chain 2: 
Chain 2: Gradient evaluation took 1.4e-05 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.14 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 0.04 seconds (Warm-up)
Chain 2:                0.045 seconds (Sampling)
Chain 2:                0.085 seconds (Total)
Chain 2: 

SAMPLING FOR MODEL 'bernoulli' NOW (CHAIN 3).
Chain 3: 
Chain 3: Gradient evaluation took 1.1e-05 seconds
Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.11 seconds.
Chain 3: Adjust your expectations accordingly!
Chain 3: 
Chain 3: 
Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 3: 
Chain 3:  Elapsed Time: 0.039 seconds (Warm-up)
Chain 3:                0.043 seconds (Sampling)
Chain 3:                0.082 seconds (Total)
Chain 3: 

SAMPLING FOR MODEL 'bernoulli' NOW (CHAIN 4).
Chain 4: 
Chain 4: Gradient evaluation took 1e-05 seconds
Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.1 seconds.
Chain 4: Adjust your expectations accordingly!
Chain 4: 
Chain 4: 
Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
Chain 4: 
Chain 4:  Elapsed Time: 0.036 seconds (Warm-up)
Chain 4:                0.042 seconds (Sampling)
Chain 4:                0.078 seconds (Total)
Chain 4: </code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the posterior distribution</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>tibble_mod <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(mod) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prob =</span> <span class="fu">expit</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>)) <span class="sc">|&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">logodds =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># bind tibble_mod and our prior for sinner, which was created in the chunk plotting</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># both prior distributions for sinner and alcaraz</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(tibble_mod, prior_sin_df, <span class="at">.id =</span> <span class="st">"type"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">fct_recode</span>(type, <span class="st">"posterior"</span> <span class="ot">=</span> <span class="st">"1"</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                           <span class="st">"prior"</span> <span class="ot">=</span> <span class="st">"2"</span>),</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> <span class="fu">fct_relevel</span>(type, <span class="fu">c</span>(<span class="st">"prior"</span>, <span class="st">"posterior"</span>)))</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># plot both the prior and the updated prior</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> plot_df, <span class="fu">aes</span>(<span class="at">x =</span> prob)) <span class="sc">+</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> type), <span class="at">adjust =</span> <span class="dv">2</span>,</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="fl">0.9</span>) <span class="sc">+</span> <span class="do">## adjust smooths it out</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Prior and Posterior Distributions at Specific Match State"</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Sinner serving at 40-15, 1-1, 3rd set"</span>,</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Sinner's Probability of Winning a Point (on serve)"</span>,</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Sinner: 89/150 points won on serve"</span>) <span class="sc">+</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">17</span>)) <span class="sc">+</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project_Write_Up_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see that Sinner’s probability distribution of winning a point on serve when he is serving at 40-15, 1-1 in the 3rd set has shifted. As points are being played we are getting additional data, and that data is updating the distribution bit by bit. At this point of the match, we think that Sinner has a slightly higher probability of winning a point on serve than at the start of the match. With Sinner winnning 89 out of 150 points on serve at this point in the match, it makes sense that his updated distribution has shifted closer to 0.6.</p>
</section>
<section id="moving-forward" class="level3">
<h3 class="anchored" data-anchor-id="moving-forward">Moving Forward</h3>
<p>Now that we have explored how to create the probabilities of winning a point on serve and seeing how they update throughout the match, we can use these probabilities to calculate the probability of winning the match.</p>
</section>
</section>
<section id="caclulating-in-match-win-probability-alcaraz-vs-sinner-case-study-1" class="level2">
<h2 class="anchored" data-anchor-id="caclulating-in-match-win-probability-alcaraz-vs-sinner-case-study-1">Caclulating In-Match-Win Probability (Alcaraz vs Sinner, Case Study 1)</h2>
<p>With the probabilities of both players winning a point on their serve, we can calculate the probability of either player winning the entire match. We can do this by simulating the match point by point, and updating the probabilities of the players winning a point on serve as each successive point is played. For a current state of the match, we have the updated probabilities of each player winning a point on serve, and the score at that state of the match, and using these we can calculate the overall probability of winning the match.</p>
<p>For our first case study, we continue to use our example that we have talked through to set up key aspects of this project. We look at the 2022 US Open Quarterfinal match between Jannik Sinner and Carlos Alcaraz, where Alcaraz defeated Sinner 6-3, 6-7(7), 6-7(0), 7-5, 6-3 in 5 sets.</p>
<p>At the time, this match was highly anticipated to be a close match between two young, emerging stars in the tennis world. Sinner, an Italian player, was seeded 11th in the tournament and was known for his powerful groundstrokes and aggressive playing style. Alcaraz, a Spanish player, was seeded 3rd in the tournament but had been making waves in the tennis world with his athleticism and shot-making ability.</p>
<p>With Alcaraz being the winner, we are exploring the probability that Alcaraz wins the match.</p>
<p>First, we need to calculate the updated probabilities of Alcaraz and Sinner winning a point on serve after each successive point is played. To do this, we use our <code>get_probabilities_df()</code> function. This function takes in the data frames of the players’ serving points, the players’ names, the players’ original probabilities of winning a point on serve, and the players’ original standard errors. Before, we looked at Sinner’s updated probability distribution of winning a point on serve at a specific state of the match. Now, we loop through every single point of the match and obtain updated probabilities of the two players winning a point on serve after each successive point. It is worth noting that as Alcaraz serves multiple points in a row, Sinner’s probability of winning a point on serve does not change as there is no new data we are observing that would update his probability. Our output is a dataframe that contains the probabilities of the two players winning a point on serve which is updated after each successive point.</p>
<p>– TODO make sure below makes sense –</p>
<p>Note that our original probabilities of winning a point on serve at the start of the match came from us taking the mean of the log-odds serve posterior distributions of each player winning a point on serve. We then converted these log-odds to talk about them in terms of probabilities.</p>
<p>An alternative approach to calculating the probabilities of winning a point on serve is to take samples from the serve posterior distributions of the log-odds of winning a point on serve for each player. As we sample from these distributions, we convert each log-odds sample to a probability of winning a point on serve. We then average all of these probabilities to get a final probability of winning a point on serve.</p>
<p>So in our <code>get_probabilities_df()</code> function, we save both the mean log-odds and the distribution centers from sampling in the dataframe. This allows us to choose which probabilities to use later on, when we use another function to calculate the overall probability of winning the match.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>combined_prob_sin_alc_sp_df <span class="ot">&lt;-</span> <span class="fu">get_probabilities_df</span>(<span class="at">p1_serving_df =</span> sin_serving,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_serving_df =</span> alc_serving,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2 =</span> <span class="st">"Carlos Alcaraz"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_prob =</span> <span class="fl">0.2434863</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_se =</span> <span class="fl">0.1193404</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_prob =</span> <span class="fl">0.5017383</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_se =</span> <span class="fl">0.1196950</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now use the probabilities of the two players winning a point on serve to calculate the overall probability of the players winning the match. We simulate the match point by point, updating the probabilities of the players winning a point on serve as each point is played, and for each specific state of the match and probabilities of the players winning a point on serve, we can calculate the overall probability of a player to win the overall match. We use the <code>get_plot_df()</code> function to do this. As noted before the chunk above, we have the option to use the mean probabilities or the distribution centers from sampling to calculate the overall probability of winning the match. This is the <code>type</code> parameter in the function. We set this parameter to <code>"mean"</code> or <code>"distribution"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>plot_sin_alc_small_prior <span class="ot">&lt;-</span> <span class="fu">get_plot_df</span>(<span class="at">combined_df =</span> combined_prob_sin_alc_sp_df, </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">which_player_prob =</span> <span class="dv">2</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">best_of_3 =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">advantage =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="st">"distribution"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(total_sets))) <span class="sc">|&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fix last row in data set where set_number is 6, should be a 5</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">ifelse</span>(pt_number <span class="sc">==</span> <span class="fu">max</span>(pt_number), <span class="st">'5'</span>, set_number)) <span class="sc">|&gt;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(set_number))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can choose how many sets we want to display on our graph, but here we save colors for up to 5 sets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create fills to color sets by</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fills <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#F57A5C"</span>, <span class="st">"#F5C25C"</span>, <span class="st">"#94E25B"</span>, <span class="st">"#69CEE0"</span>, <span class="st">"#A875CE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we can look at just the first set of the match:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter for just the first set</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>plot_first_set_sin_alc <span class="ot">&lt;-</span> plot_sin_alc_small_prior <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(set_number <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create the boundaries for the sets</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>first_set_boundaries_alc_sin_small_prior <span class="ot">&lt;-</span> plot_sin_alc_small_prior <span class="sc">|&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(set_number) <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">xmin =</span> <span class="fu">min</span>(pt_number) <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">xmax =</span> <span class="fu">max</span>(pt_number) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(set_number <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>plot_sin_alc_small_prior <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pt_number, <span class="at">y =</span> probability)) <span class="sc">+</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> first_set_boundaries_alc_sin_small_prior, <span class="fu">aes</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">xmin =</span> xmin, <span class="at">xmax =</span> xmax, </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> set_number), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span> </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_first_set_sin_alc, <span class="fu">aes</span>(<span class="at">y =</span> win_prob_px)) <span class="sc">+</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Point Number"</span>,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Probability of Winning Match"</span>,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Alcaraz vs Sinner US Open Quarterfinal 2022"</span>,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probability of Alcaraz Winning Match"</span>,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Prior contains 'lead-up' tournaments to the 2022 USO and 2022 USO itself"</span>,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Server"</span>) <span class="sc">+</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(plot_sin_alc_small_prior))) <span class="sc">+</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> fills[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project_Write_Up_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see Alcaraz start the match with a high probability of winning the match. This makes sense, as Alcaraz’s probability of winning a point on serve (0.6228678) is much higher than Sinner’s probability of winning a point on serve (0.5605726).</p>
<p>Some notable moments in the first set are:</p>
<ul>
<li>Alcaraz breaks Sinner’s serve in the first game of the match to go up 1-0.</li>
<li>Sinner breaks back in the fourth game of the match to even the set at 2-2, and holds after a long game with many deuce points to go up 3-2.</li>
<li>Alcaraz then wins the next 4 games in a row to take the first set 6-3, so it follows that his probability of winning the match has increased since the start of the match.</li>
<li>Alcaraz’s updated probability of winning a point on serve at the end of the set is 0.624</li>
<li>Sinner’s updated probability of winning a point on serve at the end of the set is 0.549</li>
</ul>
<p>We can include all of the sets to plot the entire match:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># not necessary here since we are plotting all sets, but included anyway</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>plot_five_sets_sin_alc <span class="ot">&lt;-</span> plot_sin_alc_small_prior <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(set_number <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">2</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">3</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">4</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># create the boundaries for the sets</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>five_set_boundaries_alc_sin_small_prior <span class="ot">&lt;-</span> plot_sin_alc_small_prior <span class="sc">|&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(set_number) <span class="sc">|&gt;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">xmin =</span> <span class="fu">min</span>(pt_number) <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">xmax =</span> <span class="fu">max</span>(pt_number) <span class="sc">+</span> <span class="fl">0.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(set_number <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">2</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">3</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">4</span> <span class="sc">|</span> set_number <span class="sc">==</span> <span class="dv">5</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>plot_sin_alc_small_prior <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pt_number, <span class="at">y =</span> probability)) <span class="sc">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> five_set_boundaries_alc_sin_small_prior, <span class="fu">aes</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">xmin =</span> xmin, <span class="at">xmax =</span> xmax, </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> set_number), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_five_sets_sin_alc, <span class="fu">aes</span>(<span class="at">y =</span> win_prob_px)) <span class="sc">+</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Point Number"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Probability of Winning Match"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Alcaraz vs Sinner US Open Quarterfinal 2022"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probability of Alcaraz Winning Match"</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Prior contains 'lead-up' tournaments to the 2022 USO and 2022 USO itself"</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Server"</span>) <span class="sc">+</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(plot_sin_alc_small_prior))) <span class="sc">+</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> fills[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]) <span class="sc">+</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project_Write_Up_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Second set:</p>
<ul>
<li>Sinner breaks early in the set to go up 2-1</li>
<li>Sinner maintains his break of serve and is serving for the set up 5-3</li>
<li>Alcaraz breaks back to even the set at 5-5</li>
<li>Sinner is serving at 5-6, 0-40, and Alcaraz’s probability of winning the match is very high</li>
<li>Sinner saves multiple set points and forces a tiebreaker</li>
<li>Both players save set points in the tiebreaker, but Sinner pulls away to win it 9-7</li>
<li>Alcaraz’s updated probability of winning a point on serve at the end of the set is 0.635</li>
<li>Sinner’s updated probability of winning a point on serve at the end of the set is 0.563</li>
</ul>
<p>Third set:</p>
<ul>
<li>The set starts with the players trading holds</li>
<li>Alcaraz breaks serve to go up 3-2</li>
<li>Alcaraz is serving at 4-3 and Sinner breaks back for 4-4</li>
<li>At 5-5, Alcaraz breaks Sinner’s serve to go up 6-5 serving for the set</li>
<li>Sinner breaks Alcaraz’s serve to force a tiebreaker</li>
<li>Sinner runs away with the tiebreaker and the set, winning all 7 points in a row (7-0)</li>
<li>Alcaraz’s updated probability of winning a point on serve at the end of the set is 0.620</li>
<li>Sinner’s updated probability of winning a point on serve at the end of the set is 0.570</li>
</ul>
<p>Fourth set:</p>
<ul>
<li>Sinner breaks Alcaraz’s serve in the first game of the set, 1-0</li>
<li>With Sinner servng at 3-2, Alcaraz breaks back to even the set at 3-3</li>
<li>Sinner breaks right back to go up 4-3</li>
<li>Sinner has a match point serving at 5-4, Ad-In, but Alcaraz saves it, and breaks for 5-5</li>
<li>Alcaraz holds for 6-5, and breaks Sinner to win the set 7-5</li>
<li>Alcaraz’s updated probability of winning a point on serve at the end of the set is 0.617</li>
<li>Sinner’s updated probability of winning a point on serve at the end of the set is 0.563</li>
</ul>
<p>Fifth set:</p>
<ul>
<li>The players trade holds early</li>
<li>Sinner breaks Alcaraz’s serve to go up 3-2</li>
<li>Alcaraz breaks right back and then holds to go up 4-3</li>
<li>Alcaraz breaks again to go up 5-3</li>
<li>Alcaraz holds to win the set 6-3, and win the overall match</li>
<li>Alcaraz’s updated probability of winning a point on serve at the end of match set is 0.620</li>
<li>Sinner’s updated probability of winning a point on serve at the end of the match is 0.557</li>
</ul>
<p>Observing the dips and peaks in the probability of winning the match as serves were broken and held, and sets won shows how quickly momentum can shift in a tennis match. The probability of winning the match is not always a smooth curve, and can change rapidly with the outcome of a few points, especially in a tight-fought match like this one.</p>
</section>
<section id="changing-prior-distributions-alcaraz-vs-sinner" class="level2">
<h2 class="anchored" data-anchor-id="changing-prior-distributions-alcaraz-vs-sinner">Changing Prior Distributions (Alcaraz vs Sinner)</h2>
<p>We can change what matches we include in our prior distributions and see how this affects our probabilities of each player winning a point on serve at the start of the match. With these different probabilities of winning a point on serve, we can see how the overall probability of winning the match changes.</p>
<p>For our example above, we explored the probability of Alcaraz winning the match against Sinner using matches from the hard court lead-up tournaments to the 2022 US Open and the 2022 US Open itself to form our prior distribution. Now, we compare this to two more possible prior distributions.</p>
<p>We can look at a prior generated that includes all hard court matches from the 2021 US Open to the quarterfinal round of the 2022 US Open. This is our “Large Prior” distribution that includes more matches than our original “Small Prior” distribution. Due to the larger sample size of matches, we expect to see smaller changes in the updates of the probabilities of winning a point on serve throughout the match.</p>
<p>We can also explore what happens if we fix the probabilities of Sinner and Alcaraz winning a point on serve at a specific value, which we set at 0.68 for both players (around tour average). We observe what happens when we fix this value for the match.</p>
<p>The different priors we choose change the probabilities of winning a point on serve at the start of the match and thus alter the overall probability of Alcaraz winning the match. We can see this in the plot below.</p>
<p>But first, we must generate our new priors and calculate the probabilities of winning a point on serve at the start of the match and update them accordingly. We start with our “Large Prior” distribution and then move on to the fixed probabilities.</p>
<p>We again use our <code>create_prior()</code> function to calculate these values on the log-odds scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>aug_mod_sin_large_prior <span class="ot">&lt;-</span> <span class="fu">create_prior</span>(<span class="at">ext =</span> <span class="fu">c</span>(<span class="st">"atp_matches_2021.csv"</span>,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"atp_matches_2022.csv"</span>),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tourn_name =</span> <span class="st">"Us Open"</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">surf =</span> <span class="st">"Hard"</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">start_date =</span> <span class="st">"2021-08-30"</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">end_date =</span> <span class="st">"2022-09-06"</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player2 =</span> <span class="st">"Carlos Alcaraz"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ref_player =</span> <span class="st">"Novak Djokovic"</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>aug_mod_sin_large_prior <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the output, we see that Sinner has a mean value of winning a point while serving against Alcaraz of 0.4288085 with a standard error of 0.0491917, and both of these are on the log odds scale. We can also see that Sinner has a mean value of winning a point while returning against Alcaraz of -0.4795682 with a standard error of 0.0497102, and again both on the log odds scale. To get the log odds of Alcaraz winning a point while serving against Sinner, we can negate the value of Sinner winning a point while returning against Alcaraz. We can then convert these from the log-odds scale to probabilities of winning a point on serve using the logistic function expit(). The logistic function transforms the log-odds to probabilities, ensuring that the probabilities fall within the range [0, 1]. Note that the standard error is also smaller than the “Small Prior” distribution, as we have more matches included in our “Large Prior” distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Sinner wins a point on serve</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fl">0.4288085</span>) <span class="co"># 0.6055891</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6055891</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Sinner wins a point on return</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="sc">-</span><span class="fl">0.4795682</span>) <span class="co">#  0.3823541</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3823541</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Alcaraz wins a point on serve</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fl">0.4795682</span>) <span class="co"># 0.6176459</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6176459</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Alcaraz wins a point on return</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="sc">-</span><span class="fl">0.4288085</span>) <span class="co"># 0.3944109</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3944109</code></pre>
</div>
</div>
<p>Compared to our “Small Prior” distribution, we see that the probabilities of Sinner and Alcaraz winning a point on serve have changed. From our “Small Prior” distribution, Sinner had a probability of 0.5605726 of winning a point on serve, and Alcaraz had a probability of 0.6228678 of winning a point on serve. We have seen an increase in Sinner’s probability, and a decrease in Alcaraz’s probability from that prior to this prior.</p>
<p>We can then calculate the probabilities of them winning a point on their serve throughout the entire match, updating after each point using our <code>get_probabilities_df()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>combined_prob_alc_sin_lp_df <span class="ot">&lt;-</span> <span class="fu">get_probabilities_df</span>(<span class="at">p1_serving_df =</span> sin_serving,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_serving_df =</span> alc_serving,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2 =</span> <span class="st">"Carlos Alcaraz"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_prob =</span> <span class="fl">0.4288085</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_se =</span> <span class="fl">0.04919170</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_prob =</span> <span class="fl">0.4795682</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_se =</span> <span class="fl">0.04971023</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the probabilities of the two players winning a point on serve and the current score of the match as we feed it in, we can calculate the overall probability of winning the match.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>plot_sin_alc_large_prior <span class="ot">&lt;-</span> <span class="fu">get_plot_df</span>(<span class="at">combined_df =</span> combined_prob_alc_sin_lp_df,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">which_player_prob =</span> <span class="dv">2</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">best_of_3 =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">advantage =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">type =</span> <span class="st">"distribution"</span>) <span class="sc">|&gt;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(total_sets))) <span class="sc">|&gt;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fix last row in data set where set_number is 6, should be a 5</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">ifelse</span>(pt_number <span class="sc">==</span> <span class="fu">max</span>(pt_number), <span class="st">'5'</span>, set_number)) <span class="sc">|&gt;</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(set_number))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have our overall probability of Alcaraz winning the match that updates after each point is played. We can plot this, but first let’s work through the code to generate the probability of Alcaraz winning the match when we fix both players’ probabilities of winning a point on serve at 0.68. A lot of the code here is tidied and packed away in functions that we have used, but we have to do it manually here to input the 0.68 values for both players.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>sin_serving_fp <span class="ot">&lt;-</span> sin_serving <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">player1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">player2 =</span> <span class="st">"Carlos Alcaraz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also create indicator if serving player won the point</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">server_won =</span> <span class="fu">ifelse</span>(PointWinner <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>alc_serving_fp <span class="ot">&lt;-</span> alc_serving <span class="sc">|&gt;</span> </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">player1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">player2 =</span> <span class="st">"Carlos Alcaraz"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also create indicator if serving player won the point</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">server_won =</span> <span class="fu">ifelse</span>(PointWinner <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>combined_sin_alc_fixed_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(sin_serving_fp, alc_serving_fp) <span class="sc">|&gt;</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(pt_number) <span class="sc">|&gt;</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">p1_wserv_prob =</span> <span class="fl">0.68</span>,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">p2_wserv_prob =</span> <span class="fl">0.68</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">P1SetsWon =</span> <span class="fu">cumsum</span>(SetWinner <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">P2SetsWon =</span> <span class="fu">cumsum</span>(SetWinner <span class="sc">==</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pt_number, player1, player2, PointServer, p1_wserv_prob, p2_wserv_prob,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>         P1PointsWon, P2PointsWon, P1GamesWon, P2GamesWon, P1SetsWon, P2SetsWon) <span class="sc">|&gt;</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PointServer =</span> <span class="fu">case_when</span>(P1PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>                                   P2PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>                                   PointServer <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>                                 P1PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>                                   P2PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>                                   PointServer <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>                                 <span class="cn">TRUE</span> <span class="sc">~</span> PointServer))</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>plot_sin_alc_fixed_prior <span class="ot">&lt;-</span> <span class="fu">get_plot_df</span>(<span class="at">combined_df =</span> combined_sin_alc_fixed_df, </span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">which_player_prob =</span> <span class="dv">2</span>,</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>                        <span class="at">best_of_3 =</span> <span class="cn">FALSE</span>,</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>                        <span class="at">advantage =</span> <span class="cn">FALSE</span>,</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="st">"mean"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(total_sets))) <span class="sc">|&gt;</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fix last row in data set where set_number is 6, should be a 5</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">ifelse</span>(pt_number <span class="sc">==</span> <span class="fu">max</span>(pt_number), <span class="st">'5'</span>, set_number)) <span class="sc">|&gt;</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(set_number))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now that we have the probabilities of Alcaraz winning the match with our “Small Prior”, “Large Prior”, and the fixed probability of both Sinner and Alcaraz winning a point on serve set at 0.68, we can plot these alongside one another.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>plot_sin_alc_small_prior <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pt_number, <span class="at">y =</span> probability)) <span class="sc">+</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> win_prob_px, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="fu">factor</span>(<span class="st">"Small Prior"</span>, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Small Prior"</span>, </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"Large Prior"</span>, </span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"Fixed Probability"</span>))), </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_sin_alc_large_prior, </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> win_prob_px, <span class="at">color =</span> <span class="st">"Large Prior"</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> plot_sin_alc_fixed_prior, </span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">y =</span> win_prob_px, </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"Fixed Probability (0.68)"</span>), </span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Point Number"</span>,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Probability of Winning Match"</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Alcaraz vs Sinner US Open Quarterfinal 2022"</span>,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probability of Alcaraz Winning Match with Different Priors"</span>,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Comparing Different Prior Distributions"</span>,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Server"</span>) <span class="sc">+</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Small Prior"</span> <span class="ot">=</span> <span class="st">"red"</span>, </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Large Prior"</span> <span class="ot">=</span> <span class="st">"blue"</span>, </span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Fixed Probability"</span> <span class="ot">=</span> <span class="st">"green"</span>),</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Small Prior"</span>, </span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Large Prior"</span>, </span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Fixed Probability (0.68)"</span>)) <span class="sc">+</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(plot_sin_alc_small_prior))) <span class="sc">+</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_viridis_d</span>(<span class="at">end =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">110</span>, <span class="at">y =</span> <span class="fl">0.2</span>, </span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"Starting Win-Serve Probabilities:"</span>, </span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">110</span>, <span class="at">y =</span> <span class="fl">0.15</span>, </span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>             <span class="st">"'Small Prior - '*p[alcaraz]: 0.6229*', '*p[sinner]: 0.5606"</span>), </span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">110</span>, <span class="at">y =</span> <span class="fl">0.1</span>, </span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>             <span class="st">"'Large Prior - '*p[alcaraz]: 0.61768*', '*p[sinner]: 0.6056"</span>), </span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">parse =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">110</span>, <span class="at">y =</span> <span class="fl">0.05</span>, </span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">"'Fixed Probability - '*p[alcaraz]: 0.68*', '*p[sinner]: 0.68"</span>, </span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">parse =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project_Write_Up_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can see here now that using different priors changes the probabilities of Alcaraz and Sinner winning a point on their serve at the start of the match, and lead to different probabilities of Alcaraz winning the overall match. The different probabilities of winning a point at the start of the match for the different players are shown in the annotations on the bottom left of the plot.</p>
<p>The prior we originally looked at for this match is the purple line labeled “Small Prior”. In the “Small Prior” we included leadup tournaments to the 2022 US Open and the early rounds of the 2022 US Open to calculate the probabilities of Sinner and Alcaraz winning a point on their serve. We see that this line starts with the highest probability of Alcaraz winning the match, due to this prior generating probabilities of winning a point on serve between the two players that had the greatest difference between them (in favor of Alcaraz).</p>
<p>In the “Large Prior”, the blueish line, we are including all hard court matches over the last year including the 2021 US Open, and early rounds of the 2022 US Open. The probabilities of winning a point on serve for the two players are closer together in this prior, and we see that the probability of Alcaraz winning the match is lower at the start of the match compared to the “Small Prior”.</p>
<p>We can also see what happens when we fix both of their probabilities of winning a point on serve at 0.68, and this is the yellow line here. The probability of Alcaraz winning the match starts at 0.5, as we would expect, due to both players having the same probability of winning a point on serve.</p>
<p>We can see the changes in the probability of Alcaraz winning the match based on these different starting probabilities of winning a point on serve, which we generated using different prior distributions.</p>
</section>
<section id="caclulating-in-match-win-probability-gauff-vs-sabalenka-case-study-2" class="level2">
<h2 class="anchored" data-anchor-id="caclulating-in-match-win-probability-gauff-vs-sabalenka-case-study-2">Caclulating In-Match-Win Probability (Gauff vs Sabalenka, Case Study 2)</h2>
<p>We can explore any match with the set up of the project. For our second case study, we look at the 2023 US Open Women’s Singles Final match between Coco Gauff and Arnya Sabalenka.</p>
<p>Gauff, a young, rising American star was looking for her first Grand Slam title at the age of 19. Sabalenka, a powerful Belarusian player, was looking for her second Grand Slam title, winning the Australian Open back in January of that year. Gauff came into the tournament on a very hot streak, having won lead-up tournaments in Washington, D.C. and Cincinnati. The win in D.C. was her first at the WTA 500 level, and in Cincinnati her first at the Masters 1000 level.</p>
<p>Gauff was able to come from behind and win in 3 sets: 2-6, 6-3, 6-2, and capture her first Grand Slam title.</p>
<p>In women’s tennis breaks of serve are more common. This is because women are often better returners, and often generate less of an advantage when serving. On the men’s side we saw big spikes for breaking serve on the plot of in-match-win probability. On the women’s side we see some jumps for both breaks and holds, and the jumps may not be as extreme.</p>
<p>With Gauff winning the match, we are exploring the probability that Gauff wins the match.</p>
<p>First, we need to calculate the probability of Gauff winning a point while serving against Sabalenka and the probability of Sabalenka winning a point while serving against Gauff. We use our <code>create_prior()</code> function again, and use a similar prior from the exploration of the match between Sinner and Alcaraz. For the prior, we include matches in the hard court lead-up tournaments to the 2023 Women’s US Open and the earlier rounds of the 2023 US Open before the final was played.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>aug_mod_gau_small_prior <span class="ot">&lt;-</span> <span class="fu">create_prior</span>(<span class="at">ext =</span> <span class="st">"wta_matches_2023.csv"</span>,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tourn_name =</span> <span class="st">"Us Open"</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">surf =</span> <span class="st">"Hard"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">start_date =</span> <span class="st">"2023-07-24"</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">end_date =</span> <span class="st">"2023-09-8"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player1 =</span> <span class="st">"Coco Gauff"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player2 =</span> <span class="st">"Aryna Sabalenka"</span>,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ref_player =</span> <span class="st">"Iga Swiatek"</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>aug_mod_gau_small_prior <span class="sc">|&gt;</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the output, we see that Gauff has a mean value of winning a point while serving against Sabalenka of <code>0.3555439</code> with a standard error of <code>0.1026245</code>, and both of these are on the log-odds scale. We can also see that Gauff has a mean value of winning a point while returning against Sabalenka of <code>-0.1906711</code> with a standard error of <code>0.1049427</code>. We can negate the value of Gauff winning a point while returning against Sabalenka to get Sabalenka’s probability of winning a point while serving against Gauff. We can then convert these from the log-odds scale to probabilities of winning a point on serve using the logistic function <code>expit()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Gauff wins a point on serve</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fl">0.3555439</span>) <span class="co"># 0.5879613</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5879613</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Gauff wins a point on return</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="sc">-</span><span class="fl">0.1906711</span>) <span class="co"># 0.4524761</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4524761</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Sabalenka wins a point on serve</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="fl">0.1906711</span>) <span class="co"># 0.5475239</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5475239</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># probability Sabalenka wins a point on return</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">expit</span>(<span class="sc">-</span><span class="fl">0.3555439</span>) <span class="co"># 0.4120387</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4120387</code></pre>
</div>
</div>
<p>We can load in our point-level data for the match with our function <code>wrangle_point_level()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># returns list of two data frames</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>both_gauff_saba_serving_df <span class="ot">&lt;-</span> <span class="fu">wrangle_point_level</span>(<span class="at">ext =</span> <span class="st">"2023-usopen-points.csv"</span>,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ID =</span> <span class="st">"2023-usopen-2701"</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co"># first data frame corresponds to player1 (Gauff)</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>gauff_serving <span class="ot">&lt;-</span> both_gauff_saba_serving_df[[<span class="dv">1</span>]]</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co"># second data frame corresponds to player2 (Sabalenka)</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>saba_serving <span class="ot">&lt;-</span> both_gauff_saba_serving_df[[<span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use the <code>get_probabilities_df()</code> function to calculate the updated probabilities of Gauff and Sabalenka winning a point on serve after each successive point is played.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>combined_prob_gauff_sab_sp_df <span class="ot">&lt;-</span> <span class="fu">get_probabilities_df</span>(<span class="at">p1_serving_df =</span> gauff_serving,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_serving_df =</span> saba_serving,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1 =</span> <span class="st">"Coco Gauff"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2 =</span> <span class="st">"Aryna Sabalenka"</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_prob =</span> <span class="fl">0.3555439</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_se =</span> <span class="fl">0.1026245</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_prob =</span> <span class="fl">0.1906711</span>,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_se =</span> <span class="fl">0.1049427</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the probabilities of the Gauff and Sabalenka winning a point on serve updated for the entire match, we can calculate the overall probability of the Gauff winning the match. We use the <code>get_plot_df()</code> function to do this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>plot_gauff_sab_small_prior <span class="ot">&lt;-</span> <span class="fu">get_plot_df</span>(<span class="at">combined_df =</span> combined_prob_gauff_sab_sp_df,</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">which_player_prob =</span> <span class="dv">1</span>,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">best_of_3 =</span> <span class="cn">TRUE</span>,</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">advantage =</span> <span class="cn">FALSE</span>,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">type =</span> <span class="st">"distribution"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(<span class="fu">as.numeric</span>(total_sets))) <span class="sc">|&gt;</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fix last row in data set where set_number is 4, should be a 3</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">ifelse</span>(pt_number <span class="sc">==</span> <span class="fu">max</span>(pt_number), <span class="st">'3'</span>, set_number)) <span class="sc">|&gt;</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">set_number =</span> <span class="fu">as.factor</span>(set_number))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And now we can plot the probability of Gauff winning the match:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the boundaries for the sets</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>set_boundaries_gauff_sab_small_prior <span class="ot">&lt;-</span> plot_gauff_sab_small_prior <span class="sc">|&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(set_number) <span class="sc">|&gt;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">xmin =</span> <span class="fu">min</span>(pt_number) <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">xmax =</span> <span class="fu">max</span>(pt_number) <span class="sc">+</span> <span class="fl">0.5</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>plot_gauff_sab_small_prior <span class="sc">|&gt;</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> pt_number, <span class="at">y =</span> probability)) <span class="sc">+</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rect</span>(<span class="at">data =</span> set_boundaries_gauff_sab_small_prior, </span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">xmin =</span> xmin, <span class="at">xmax =</span> xmax, </span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>, <span class="at">fill =</span> set_number), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span> </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> win_prob_px)) <span class="sc">+</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Point Number"</span>,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Probability of Winning Match"</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Gauff vs Sabalenka US Open Final 2023"</span>,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Probability of Gauff Winning Match"</span>,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Prior contains 'lead-up' tournaments to the 2023 USO and 2023 USO itself"</span>,</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Server"</span>) <span class="sc">+</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>)) <span class="sc">+</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Project_Write_Up_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We see Gauff start with a high probability of winning the match (above 0.5) due to her probability of winning a point on serve being higher than Sabalenka’s at the beginning of the match.</p>
<p>First set:</p>
<ul>
<li>Sabalenka starts off hot and breaks Gauff’s serve in the first game of the match</li>
<li>With Sabalenka serving at 2-1, Gauff breaks back to level the set at 2-2</li>
<li>Sabalenka wins the next 4 games to take the first set 6-2</li>
<li>Gauff’s updated probability of winning a point on serve at the end of the set is 0.578</li>
<li>Sabalenkas’ updated probability of winning a point on serve at the end of the set is 0.552</li>
</ul>
<p>We see Gauff’s probability of winning the match drop significantly after this first set.</p>
<p>Second set:</p>
<ul>
<li>Gauff saves multiple break points in the first game and is able to hold for 1-0</li>
<li>Gauff breaks Sabalenka’s serve in the fourth game of the set to go up 3-1</li>
<li>Gauff is able to maintain her break of serve and take the second set 6-3</li>
<li>Gauff’s updated probability of winning a point on serve at the end of the set is 0.585</li>
<li>Sabalenkas’ updated probability of winning a point on serve at the end of the set is 0.554</li>
</ul>
<p>Third set:</p>
<ul>
<li>Gauff breaks Sabalenka’s serve in the first game of the set</li>
<li>Gauff holds for 2-0</li>
<li>Gauff breaks Sabalenka’s serve again in the third game of the set</li>
<li>Gauff holds for 4-0</li>
<li>Sabalenka slows Gauff’s momentum as she holds for 1-4</li>
<li>Sabalenka breaks Gauff’s serve, 2-4</li>
<li>Gauff breaks right back to go up 5-2, and serves out the match to win 6-2</li>
<li>Gauff’s updated probability of winning a point on serve at the end of the match is 0.587</li>
<li>Sabalenkas’ updated probability of winning a point on serve at the end of match set is 0.546</li>
</ul>
<p>As noted before, breaks of serve are not as valuable in women’s tennis. Because of this, the probabilities of winning the match tend to not go towards 0 or 1 as much. However, if Sabalenka were to have gone up early in the second set by a break or two, Gauff’s probability of winning would have dropped quite low. Matches that are mostly one-sided, straight-set victories will have a player’s probability of winning the match be close to 0 or 1 (depending on which player is being looked at), in both men’s and women’s matches. None of the sets being closer than 6-3 in this match also contributed to the probabilities not going towards 0 or 1.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In conclusion, we’ve gotten to look into the use of Bayesian modeling at estimating the outcome of a match. We’ve seen how we can estimate the probabilities of players winning a point on their serve at the start of a match, and update these probabilities as each point of a match is played. We can use these probabilities as well as the score of the match to come up with a players probability of winning a match.</p>
<p>We’ve seen how tennis matches unfold with rapid momentum shifts, highlighting the importance of adaptively updating win probabilities with each point scored. Our Bayesian approach allows for this dynamic adjustment, providing an understanding of players’ performance trajectories over the course of a match.</p>
<p>Through comprehensive match data and Bayesian statistical methods, we’ve uncovered insights into players’ serve probabilities and their pivotal role in determining match outcomes.</p>
<p>Looking ahead, our project sets the stage for further exploration and refinement. Future research could involve fine-tuning prior distributions, integrating real-time match data for more accurate predictions, and extending the analysis to encompass different tennis contexts and even other sports. By continually adapting Bayesian modeling techniques, we can explore many predictive applications beyond tennis, contributing to advancements in sports analytics and beyond.</p>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>I would like to thank Jeff Sackman for providing the data used in this project. The data was obtained from his GitHub repository, which can be found <a href="https://github.com/JeffSackmann">here</a>. Having stats for every point in a match is invaluable for this type of analysis, and the amount of matches available is impressive.</p>
<p>I would also like to thank skoval for their work on the <code>deuce</code> package. The package is helps with calculating the in-match-win probability, using the function <code>in_match_win()</code>.</p>
<p>I also want to thank James Wolpe, St.&nbsp;Lawrence Class of 2023, for his work on paired competition models prior distributions. His work in his <code>compr</code> package was used in creating the prior distributions for the players in this project.</p>
<p>Last but not at all least, I want to thank my advisor, Dr.&nbsp;Matt Higham, for his guidance and support throughout this project. It was a pleasure working with him, and his expertise in statistics, as well as his knowledge of and interest in tennis, was invaluable in the completion of this project.</p>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
<p>In this appendix, we have relevant code snippets and functions used in the project. These include:</p>
<ol type="1">
<li>Reading in Match Data: Function to read ATP and WTA match data from Jeff Sackmann’s GitHub repository.</li>
<li>Creating Prior Distributions: Function to create prior distributions of player probabilities of winning a point on serve at the start of a match.</li>
<li>Reading in Point-by-Point Data: Function to read point-by-point data from Jeff Sackmann’s GitHub repository for a specific match of interest.</li>
<li>Getting Probabilities of Winning Point on Serve Throughout the Match: Function to calculate the probabilities of winning a point on serve for each player throughout the match.</li>
<li>Getting Data Frame for Plotting Win Probabilities: Function to prepare data frame for plotting win probabilities during the match.</li>
</ol>
<section id="reading-in-match-data" class="level3">
<h3 class="anchored" data-anchor-id="reading-in-match-data">Reading in Match data</h3>
<p>Function that reads in ATP and WTA match data from Jeff Sackmann’s GitHub repository.</p>
<p>Inputs:</p>
<ul>
<li><code>ext</code>: extension of the file to read in. Must start with ‘atp’ or ‘wta’</li>
</ul>
<p>Output:</p>
<ul>
<li>Data frame with data on matches from the specified extension</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>read_matches <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">ext =</span> <span class="st">"atp_matches_2022.csv"</span>) {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">substr</span>(ext, <span class="dv">1</span>, <span class="dv">3</span>) <span class="sc">==</span> <span class="st">"atp"</span>) {</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">"https://raw.githubusercontent.com/JeffSackmann/tennis_atp/master/"</span>, </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>      ext)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">substr</span>(ext, <span class="dv">1</span>, <span class="dv">3</span>) <span class="sc">==</span> <span class="st">"wta"</span>) {</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"https://raw.githubusercontent.com/JeffSackmann/tennis_wta/master/"</span>, </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>      ext)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid extension. Extension must start with 'atp' or 'wta'."</span>)</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(url, <span class="at">col_types =</span> <span class="fu">list</span>(<span class="at">match_num =</span> <span class="fu">col_character</span>())) <span class="sc">|&gt;</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">winner_seed =</span> <span class="fu">as.numeric</span>(winner_seed)) <span class="sc">|&gt;</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">loser_seed =</span> <span class="fu">as.numeric</span>(loser_seed))</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-prior-distributions" class="level3">
<h3 class="anchored" data-anchor-id="creating-prior-distributions">Creating Prior Distributions</h3>
<p>Function that creates prior distributions of player probabilities of winning a point on serve at the start of a match.</p>
<p>Inputs:</p>
<ul>
<li><code>ext</code>: extension of the file to read in. Must start with ‘atp’ or ‘wta’.</li>
<li><code>tourn_name</code>: name of the tournaments to include in prior</li>
<li><code>surf</code>: surface of the tournaments to include in prior</li>
<li><code>start_date</code>: start date of the tournaments to include in prior</li>
<li><code>end_date</code>: end date of the tournaments to include in prior</li>
<li><code>player1</code>: name of player 1</li>
<li><code>player2</code>: name of player 2</li>
<li><code>ref_player</code>: name of reference player</li>
</ul>
<p>Output:</p>
<ul>
<li>Data frame with:
<ul>
<li>probability of player1 winning a point on serve at the start of the match</li>
<li>sd of the probability of player1 winning a point on serve at the start of the match</li>
<li>probability of player1 winning a point on return at the start of the match</li>
<li>sd of the probability of player1 winning a point on return at the start of the match</li>
</ul></li>
<li>Note that the probabilities and sd are on the log odds scale</li>
<li>Note that we can calculate the probability of player2 winning a point on serve at the start of the match by subtracting the probability of player1 winning a point on return at the start of the match from 1</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>create_prior <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">ext =</span> <span class="fu">c</span>(<span class="st">"atp_matches_2021.csv"</span>,</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"atp_matches_2022.csv"</span>),</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">tourn_name =</span> <span class="st">"Us Open"</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">surf =</span> <span class="st">"Hard"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">start_date =</span> <span class="st">"2021-08-30"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">end_date =</span> <span class="st">"2022-09-06"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">player2 =</span> <span class="st">"Carlos Alcaraz"</span>,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">ref_player =</span> <span class="st">"Novak Djokovic"</span>) {</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  matches <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(ext, read_matches) <span class="sc">|&gt;</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">round =</span> <span class="fu">case_when</span>(round <span class="sc">==</span> <span class="st">"F"</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>                             round <span class="sc">==</span> <span class="st">"SF"</span> <span class="sc">~</span> <span class="dv">4</span>,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>                             round <span class="sc">==</span> <span class="st">"QF"</span> <span class="sc">~</span> <span class="dv">8</span>,</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>                             round <span class="sc">==</span> <span class="st">"R16"</span> <span class="sc">~</span> <span class="dv">16</span>,</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>                             round <span class="sc">==</span> <span class="st">"R32"</span> <span class="sc">~</span> <span class="dv">32</span>,</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>                             round <span class="sc">==</span> <span class="st">"R64"</span> <span class="sc">~</span> <span class="dv">64</span>,</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>                             round <span class="sc">==</span> <span class="st">"R128"</span> <span class="sc">~</span> <span class="dv">128</span>,</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>                             <span class="at">.default =</span> <span class="cn">NA</span>)) <span class="do">## covers RR matches</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## figure out match of interest based on players and tourn_name</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>  match_of_interest <span class="ot">&lt;-</span> matches <span class="sc">|&gt;</span> <span class="fu">filter</span>(tourney_name <span class="sc">==</span> tourn_name) <span class="sc">|&gt;</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>((winner_name <span class="sc">==</span> player1 <span class="sc">|</span> winner_name <span class="sc">==</span> player2) <span class="sc">&amp;</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>             (loser_name <span class="sc">==</span> player1 <span class="sc">|</span> loser_name <span class="sc">==</span> player2))</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>  <span class="do">## return an error if a player or tournament is misspelled or</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## the match-up did not happen for that particular tournament</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(match_of_interest) <span class="sc">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"There is no match for the specified players and tournament."</span>)</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(match_of_interest) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"There is more than one match for the specified players and tournament."</span>)</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>  <span class="do">## grab the round from the match of interest</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  round_of_interest <span class="ot">&lt;-</span> match_of_interest <span class="sc">|&gt;</span> <span class="fu">pull</span>(round)</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>  <span class="do">## filter for relevant matches</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>  prior <span class="ot">&lt;-</span> matches <span class="sc">|&gt;</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tourney_date =</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(tourney_date)) <span class="sc">|&gt;</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>((tourney_name <span class="sc">==</span> tourn_name <span class="sc">|</span> surface <span class="sc">==</span> surf) <span class="sc">&amp;</span></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>             (tourney_date <span class="sc">&lt;=</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(end_date) <span class="sc">&amp;</span> </span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>                tourney_date <span class="sc">&gt;=</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(start_date))) <span class="sc">|&gt;</span></span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>    <span class="do">## add a filter to remove matches beyond the match of interest</span></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>((tourney_name <span class="sc">!=</span> tourn_name) <span class="sc">|</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>             (tourney_name <span class="sc">==</span> tourn_name <span class="sc">&amp;</span> </span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>                lubridate<span class="sc">::</span><span class="fu">year</span>(tourney_date) <span class="sc">!=</span> lubridate<span class="sc">::</span><span class="fu">year</span>(end_date)) <span class="sc">|</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>             (tourney_name <span class="sc">==</span> tourn_name <span class="sc">&amp;</span> round <span class="sc">&gt;</span> round_of_interest))</span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a>  prior_points <span class="ot">&lt;-</span> prior <span class="sc">|&gt;</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">9</span>,<span class="dv">11</span>,<span class="dv">17</span>,<span class="dv">19</span>,<span class="dv">24</span>,<span class="dv">30</span>,<span class="dv">32</span>,<span class="dv">33</span>,<span class="dv">39</span>,<span class="dv">41</span>,<span class="dv">42</span>,<span class="dv">46</span>,<span class="dv">48</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">w_svpt_w =</span> w_1stWon <span class="sc">+</span> w_2ndWon,</span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a>           <span class="at">w_svpt_l =</span> w_svpt <span class="sc">-</span> w_svpt_w,</span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>           <span class="at">l_svpt_w =</span> l_1stWon <span class="sc">+</span> l_2ndWon,</span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a>           <span class="at">l_svpt_l =</span> l_svpt <span class="sc">-</span> l_svpt_w) <span class="sc">|&gt;</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(winner_name, loser_name, w_svpt_w, w_svpt_l, </span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>           l_svpt_w, l_svpt_l, match_num,</span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a>           <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">16</span><span class="sc">:</span><span class="dv">17</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"w_svpt_w"</span>, <span class="st">"w_svpt_l"</span>, <span class="st">"l_svpt_w"</span>, <span class="st">"l_svpt_l"</span>),</span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"won_point"</span>,</span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"server"</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pt_winner =</span> <span class="fu">recode</span>(</span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>      won_point,</span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>      <span class="st">"w_svpt_w"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>      <span class="st">"w_svpt_l"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>      <span class="st">"l_svpt_w"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a>      <span class="st">"l_svpt_l"</span> <span class="ot">=</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pt_server =</span> <span class="fu">recode</span>(</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a>      won_point,</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>      <span class="st">"w_svpt_w"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a>      <span class="st">"w_svpt_l"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a>      <span class="st">"l_svpt_w"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a>      <span class="st">"l_svpt_l"</span> <span class="ot">=</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># remove rows where server is NA (walkovers)</span></span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(server))</span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a>  prior_points_uncount <span class="ot">&lt;-</span> <span class="fu">uncount</span>(prior_points, <span class="at">weights =</span> <span class="fu">as.numeric</span>(server)) <span class="sc">|&gt;</span></span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p1_server =</span> <span class="fu">ifelse</span>(pt_server <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb51-79"><a href="#cb51-79" aria-hidden="true" tabindex="-1"></a>           <span class="at">p2_server =</span> <span class="fu">ifelse</span>(pt_server <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb51-80"><a href="#cb51-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># reorganize columns</span></span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(winner_name, loser_name, pt_winner, p1_server, p2_server, <span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">player1 =</span> winner_name, <span class="at">player2 =</span> loser_name)</span>
<span id="cb51-83"><a href="#cb51-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-84"><a href="#cb51-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now fit the model to your point data with serving effects</span></span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a>  comp_mod <span class="ot">&lt;-</span> <span class="fu">comp_glm</span>(pt_winner <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">data =</span> prior_points_uncount,</span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a>                       <span class="at">p1 =</span> <span class="st">"player1"</span>, <span class="at">p2 =</span> <span class="st">"player2"</span>,</span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a>                       <span class="at">p1_effects =</span> <span class="sc">~</span> p1_server, <span class="at">p2_effects =</span> <span class="sc">~</span> p2_server,</span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ref_player =</span> ref_player)</span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a>  match_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb51-91"><a href="#cb51-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">player1 =</span> (player1),</span>
<span id="cb51-92"><a href="#cb51-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">player2 =</span> (player2),</span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">p1_server =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">p2_server =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-96"><a href="#cb51-96" aria-hidden="true" tabindex="-1"></a>  aug_mod <span class="ot">&lt;-</span> <span class="fu">aug_mod</span>(comp_mod, <span class="at">newdata =</span> match_data)</span>
<span id="cb51-97"><a href="#cb51-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(aug_mod)</span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="reading-in-point-by-point-data" class="level3">
<h3 class="anchored" data-anchor-id="reading-in-point-by-point-data">Reading in Point-by-Point data</h3>
<p>Function that reads in point-by-point data from Jeff Sackmann’s GitHub repository for a specific match of interest.</p>
<p>Inputs:</p>
<ul>
<li><code>ext</code>: extension of the file to read in, tournament that contains the match of interest</li>
<li><code>ID</code>: match ID of the match to read in</li>
</ul>
<p>Outputs:</p>
<ul>
<li>Data frame with the point-by-point data for the specified match with player1 serving</li>
<li>Data frame with the point-by-point data for the specified match with player2 serving</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>wrangle_point_level <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">ext =</span> <span class="st">"2022-usopen-points.csv"</span>,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ID =</span> <span class="st">"2022-usopen-1503"</span>) {</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="fu">paste0</span>(</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://raw.githubusercontent.com/JeffSackmann/tennis_slam_pointbypoint/master/"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                               ext))</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(match_id <span class="sc">==</span> ID) <span class="sc">|&gt;</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">P1GamesWon =</span> <span class="fu">ifelse</span>(SetWinner <span class="sc">!=</span> <span class="dv">0</span>, <span class="dv">0</span>, P1GamesWon),</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">P2GamesWon =</span> <span class="fu">ifelse</span>(SetWinner <span class="sc">!=</span> <span class="dv">0</span>, <span class="dv">0</span>, P2GamesWon)) <span class="sc">|&gt;</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(PointWinner <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">select</span>(PointWinner,</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>                     P1Score,</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>                     P2Score,</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>                     P1GamesWon,</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>                     P2GamesWon,</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>                     SetWinner,</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>                     PointServer) <span class="sc">|&gt;</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">P1Score =</span> <span class="fu">ifelse</span>(P1Score <span class="sc">==</span> <span class="st">"AD"</span>, <span class="dv">4</span>, P1Score),</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">P2Score =</span> <span class="fu">ifelse</span>(P2Score <span class="sc">==</span> <span class="st">"AD"</span>, <span class="dv">4</span>, P2Score),</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">P1PointsWon =</span> <span class="fu">as.numeric</span>(P1Score),</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">P2PointsWon =</span> <span class="fu">as.numeric</span>(P2Score)) <span class="sc">|&gt;</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">P1PointsWon =</span> <span class="fu">case_when</span>(P1Score <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>                                   P1Score <span class="sc">==</span> <span class="dv">15</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>                                   P1Score <span class="sc">==</span> <span class="dv">30</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>                                   P1Score <span class="sc">==</span> <span class="dv">40</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>                                   <span class="cn">TRUE</span> <span class="sc">~</span> P1PointsWon),</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">P2PointsWon =</span> <span class="fu">case_when</span>(P2Score <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>                                   P2Score <span class="sc">==</span> <span class="dv">15</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>                                   P2Score <span class="sc">==</span> <span class="dv">30</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>                                   P2Score <span class="sc">==</span> <span class="dv">40</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>                                   <span class="cn">TRUE</span> <span class="sc">~</span> P2PointsWon)) <span class="sc">|&gt;</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pt_number =</span> <span class="fu">row_number</span>())</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>  p1_serving <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">filter</span>(PointServer <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>  p2_serving <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> <span class="fu">filter</span>(PointServer <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(p1_serving, p2_serving))</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="getting-probabilities-of-winning-point-on-serve-throughout-the-match" class="level3">
<h3 class="anchored" data-anchor-id="getting-probabilities-of-winning-point-on-serve-throughout-the-match">Getting Probabilities of Winning Point on Serve Throughout the Match</h3>
<p>Function that calculates the probabilities of winning a point on serve for each player throughout the match.</p>
<p>MAKE NOTE OF stan_glm from compr / comp_prior_start.R</p>
<p>Inputs:</p>
<ul>
<li><code>p1_serving_df</code>: data frame with point-by-point data for player1 serving from match of interest</li>
<li><code>p2_serving_df</code>: data frame with point-by-point data for player2 serving from match of interest</li>
<li><code>p1</code>: name of player1</li>
<li><code>p2</code>: name of player2</li>
<li><code>p1_original_prob</code>: original probability of player1 winning a point on serve (from create_prior, on log odds scale)</li>
<li><code>p1_original_se</code>: original standard error of player1 winning a point on serve (from create_prior, on log odds scale)</li>
<li><code>p2_original_prob</code>: original probability of player2 winning a point on serve (from create_prior, on log odds scale)</li>
<li><code>p2_original_se</code>: original standard error of player2 winning a point on serve (from create_prior, on log odds scale)</li>
</ul>
<p>Output:</p>
<ul>
<li>Data frame with point-level data and probabilities of winning a point on serve for each player throughout the match</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>get_probabilities_df <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">p1_serving_df =</span> sin_serving,</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_serving_df =</span> alc_serving,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1 =</span> <span class="st">"Jannik Sinner"</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2 =</span> <span class="st">"Carlos Alcaraz"</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_prob =</span> <span class="fl">0.4288085</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p1_original_se =</span> <span class="fl">0.04919170</span>,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_prob =</span> <span class="fl">0.4795682</span>,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">p2_original_se =</span> <span class="fl">0.04971023</span>) {</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  p1_niter <span class="ot">&lt;-</span> p1_serving_df <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  p1_prob_store <span class="ot">&lt;-</span> <span class="fu">double</span>()</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create empty list to store posterior samples</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  p1_prob_store_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  p1_serving <span class="ot">&lt;-</span> p1_serving_df <span class="sc">|&gt;</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">player1 =</span> p1,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">player2 =</span> p2) <span class="sc">|&gt;</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also create indicator if serving player won the point</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">server_won =</span> <span class="fu">ifelse</span>(PointWinner <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p1_niter) {</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(server_won <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> p1_serving <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>i),</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> binomial,</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(p1_original_prob, p1_original_se),</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    p1_prob_store[i] <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod) <span class="sc">|&gt;</span> <span class="fu">expit</span>()</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    p1_prob_store_list[[i]] <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(mod) <span class="sc">|&gt;</span> <span class="fu">expit</span>() <span class="do">## grab posterior samples</span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>  p1_serving <span class="ot">&lt;-</span> p1_serving <span class="sc">|&gt;</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p1_wserv_prob =</span> p1_prob_store,</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>           <span class="at">p1_wserv_prob_list =</span> p1_prob_store_list)</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>  <span class="do">## can have a column in a data frame that is a column of lists</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>  <span class="do">## each row has a list of 4000 posterior samples</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>  p2_niter <span class="ot">&lt;-</span> p2_serving_df <span class="sc">|&gt;</span> <span class="fu">nrow</span>()</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>  p2_prob_store <span class="ot">&lt;-</span> <span class="fu">double</span>()</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>  p2_prob_store_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>  p2_serving <span class="ot">&lt;-</span> p2_serving_df <span class="sc">|&gt;</span></span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">player1 =</span> p1,</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>           <span class="at">player2 =</span> p2) <span class="sc">|&gt;</span></span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also create indicator if serving player won the point</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">server_won =</span> <span class="fu">ifelse</span>(PointWinner <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p2_niter) {</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(server_won <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> p2_serving <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>i),</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>                    <span class="at">family =</span> binomial,</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>                    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(p2_original_prob, p2_original_se),</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>                    <span class="at">seed =</span> <span class="dv">123</span>)</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>    p2_prob_store[i] <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod) <span class="sc">|&gt;</span> <span class="fu">expit</span>()</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>    p2_prob_store_list[[i]] <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(mod) <span class="sc">|&gt;</span> <span class="fu">expit</span>()</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>  p2_serving <span class="ot">&lt;-</span> p2_serving <span class="sc">|&gt;</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">p2_wserv_prob =</span> p2_prob_store,</span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>           <span class="at">p2_wserv_prob_list =</span> p2_prob_store_list)</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine the data frames and arrange by pt_number</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>  combined_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(p1_serving, p2_serving) <span class="sc">|&gt;</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(pt_number) <span class="sc">|&gt;</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pt_number, player1, player2, PointServer, PointWinner, server_won,</span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>           p1_wserv_prob, p2_wserv_prob,</span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>           p1_wserv_prob_list, p2_wserv_prob_list,</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>           <span class="fu">everything</span>())</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  Fill in the missing probabilities with the previously known probability</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  for the list column, fill in the missing probabilities for the first</span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  match with a sample from the prior</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (combined_df<span class="sc">$</span>PointServer[<span class="dv">1</span>] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>    combined_df[<span class="dv">1</span>, <span class="st">"p2_wserv_prob"</span>] <span class="ot">&lt;-</span> p2_original_prob <span class="sc">|&gt;</span> <span class="fu">expit</span>()</span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>    combined_df[<span class="dv">1</span>, <span class="st">"p2_wserv_prob_list"</span>][[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">4000</span>, </span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>                                                       p2_original_prob,</span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>                                                       p2_original_se) <span class="sc">|&gt;</span> </span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expit</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span> <span class="ot">=</span> value) <span class="sc">|&gt;</span> </span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>()</span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>    combined_df[<span class="dv">1</span>, <span class="st">"p1_wserv_prob"</span>] <span class="ot">&lt;-</span> p1_original_prob <span class="sc">|&gt;</span> <span class="fu">expit</span>()</span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>    combined_df[<span class="dv">1</span>, <span class="st">"p1_wserv_prob_list"</span>][[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">4000</span>, </span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>                                                       p1_original_prob,</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>                                                       p1_original_se) <span class="sc">|&gt;</span> </span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expit</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span> <span class="ot">=</span> value) <span class="sc">|&gt;</span> </span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>()</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a>  combined_filled <span class="ot">&lt;-</span> combined_df <span class="sc">|&gt;</span></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fill</span>(p1_wserv_prob, p2_wserv_prob,</span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a>         p1_wserv_prob_list, p2_wserv_prob_list,</span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a>         <span class="at">.direction =</span> <span class="st">"down"</span>)</span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a>  combined_final <span class="ot">&lt;-</span> combined_filled <span class="sc">|&gt;</span></span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">P1SetsWon =</span> <span class="fu">cumsum</span>(SetWinner <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a>           <span class="at">P2SetsWon =</span> <span class="fu">cumsum</span>(SetWinner <span class="sc">==</span> <span class="dv">2</span>))</span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a>  combined_final_cleaned <span class="ot">&lt;-</span> combined_final <span class="sc">|&gt;</span></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pt_number, player1, player2, PointServer, p1_wserv_prob, p2_wserv_prob,</span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a>           P1PointsWon, P2PointsWon, P1GamesWon, P2GamesWon, P1SetsWon, P2SetsWon,</span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a>           p1_wserv_prob_list, p2_wserv_prob_list) <span class="sc">|&gt;</span></span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">PointServer =</span> <span class="fu">case_when</span>(P1PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a>                                     P2PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a>                                     PointServer <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a>                                   P1PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a>                                     P2PointsWon <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a>                                     PointServer <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a>                                   <span class="cn">TRUE</span> <span class="sc">~</span> PointServer))</span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(combined_final_cleaned)</span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="getting-data-frame-for-plotting-win-probabilities" class="level3">
<h3 class="anchored" data-anchor-id="getting-data-frame-for-plotting-win-probabilities">Getting Data Frame for Plotting Win Probabilities</h3>
<p>Inputs:</p>
<ul>
<li><code>combined_df</code>: Data frame with all the match data (from get_probabilities_df)</li>
<li><code>which_player_prob</code>: Which player’s win probability to plot (player1 or player2)</li>
<li><code>best_of_3</code>: Whether the match is best of 3 sets (<code>FALSE</code> if best of 5, <code>TRUE</code> if best of 3)</li>
<li><code>advantage</code>: Whether the match has a tiebreak in the final set (<code>FALSE</code> if no tiebreak, <code>TRUE</code> if tiebreak)</li>
<li><code>type</code>: Type of plot to create (<code>mean</code> for mean win probability, <code>distribution</code> for distribution of win probability)</li>
</ul>
<p>Output:</p>
<ul>
<li>Data frame with the necessary columns for plotting win probabilities</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>get_plot_df <span class="ot">&lt;-</span> <span class="cf">function</span>(combined_df,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">which_player_prob =</span> <span class="dv">1</span>,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">best_of_3 =</span> <span class="cn">FALSE</span>,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">advantage =</span> <span class="cn">FALSE</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">type =</span> <span class="st">"mean"</span>) {</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">!=</span> <span class="st">"mean"</span> <span class="sc">&amp;</span> type <span class="sc">!=</span> <span class="st">"distribution"</span>) {</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"`type` must be either 'mean' or 'distribution'"</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for player 1 serving</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>  p1_serv <span class="ot">&lt;-</span> combined_df <span class="sc">|&gt;</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(PointServer <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for player 2 serving</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>  p2_serv <span class="ot">&lt;-</span> combined_df <span class="sc">|&gt;</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(PointServer <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"mean"</span>) {</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create tibble for player 1 serving to feed into in_match_win</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    p1_serving_tib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_a =</span> p1_serv<span class="sc">$</span>P1PointsWon,</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_b =</span> p1_serv<span class="sc">$</span>P2PointsWon,</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_a =</span> p1_serv<span class="sc">$</span>P1GamesWon,</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_b =</span> p1_serv<span class="sc">$</span>P2GamesWon,</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_a =</span> p1_serv<span class="sc">$</span>P1SetsWon,</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_b =</span> p1_serv<span class="sc">$</span>P2SetsWon,</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">server.prob =</span> p1_serv<span class="sc">$</span>p1_wserv_prob,</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">returner.prob =</span> p1_serv<span class="sc">$</span>p2_wserv_prob</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create tibble for player 2 serving to feed into in_match_win</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    p2_serving_tib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_a =</span> p2_serv<span class="sc">$</span>P2PointsWon,</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_b =</span> p2_serv<span class="sc">$</span>P1PointsWon,</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_a =</span> p2_serv<span class="sc">$</span>P2GamesWon,</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_b =</span> p2_serv<span class="sc">$</span>P1GamesWon,</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_a =</span> p2_serv<span class="sc">$</span>P2SetsWon,</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_b =</span> p2_serv<span class="sc">$</span>P1SetsWon,</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">server.prob =</span> p2_serv<span class="sc">$</span>p2_wserv_prob,</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">returner.prob =</span> p2_serv<span class="sc">$</span>p1_wserv_prob</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate probability of player 1 winning throughout the match</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    p1_win_prob <span class="ot">&lt;-</span> p1_serving_tib <span class="sc">|&gt;</span> <span class="fu">pmap</span>(in_match_win, <span class="at">bestof3 =</span> best_of_3,</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">advantage =</span> advantage)</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add probability to player 1 serving df</span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>    p1_serv<span class="sc">$</span>probability <span class="ot">&lt;-</span> p1_win_prob</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fix the probability column</span></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>    p1_serv <span class="ot">&lt;-</span> p1_serv <span class="sc">|&gt;</span> <span class="fu">unnest</span>(probability)</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate probability of player 2 winning throughout the match</span></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>    p2_win_prob <span class="ot">&lt;-</span> p2_serving_tib <span class="sc">|&gt;</span> <span class="fu">pmap</span>(in_match_win, <span class="at">bestof3 =</span> best_of_3,</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">advantage =</span> advantage)</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add probability to player 2 df</span></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>    p2_serv<span class="sc">$</span>probability <span class="ot">&lt;-</span> p2_win_prob</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fix the probability column</span></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>    p2_serv <span class="ot">&lt;-</span> p2_serv <span class="sc">|&gt;</span> <span class="fu">unnest</span>(probability)</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"distribution"</span>) {</span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>    p1_serving_tib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_a =</span> p1_serv<span class="sc">$</span>P1PointsWon,</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_b =</span> p1_serv<span class="sc">$</span>P2PointsWon,</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_a =</span> p1_serv<span class="sc">$</span>P1GamesWon,</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_b =</span> p1_serv<span class="sc">$</span>P2GamesWon,</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_a =</span> p1_serv<span class="sc">$</span>P1SetsWon,</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_b =</span> p1_serv<span class="sc">$</span>P2SetsWon,</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">server.prob =</span> p1_serv<span class="sc">$</span>p1_wserv_prob_list,</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">returner.prob =</span> p1_serv<span class="sc">$</span>p2_wserv_prob_list</span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create tibble for player 2 serving to feed into in_match_win</span></span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>    p2_serving_tib <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_a =</span> p2_serv<span class="sc">$</span>P2PointsWon,</span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">point_b =</span> p2_serv<span class="sc">$</span>P1PointsWon,</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_a =</span> p2_serv<span class="sc">$</span>P2GamesWon,</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_b =</span> p2_serv<span class="sc">$</span>P1GamesWon,</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_a =</span> p2_serv<span class="sc">$</span>P2SetsWon,</span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">set_b =</span> p2_serv<span class="sc">$</span>P1SetsWon,</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">server.prob =</span> p2_serv<span class="sc">$</span>p2_wserv_prob_list,</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">returner.prob =</span> p2_serv<span class="sc">$</span>p1_wserv_prob_list</span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>    <span class="do">## number of rows should be number of server1 points times 4000</span></span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>    <span class="do">## unnest() gives a warning letting us know we are using the</span></span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a>    <span class="do">## "old" syntax, which is fine</span></span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>    p1_serving_tib <span class="ot">&lt;-</span> p1_serving_tib <span class="sc">|&gt;</span></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(server.prob, returner.prob) <span class="sc">|&gt;</span></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">server.prob =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>,</span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>             <span class="at">returner.prob =</span> <span class="st">`</span><span class="at">(Intercept)1</span><span class="st">`</span>)</span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate probability of player 1 winning throughout the match</span></span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>    p1_win_prob <span class="ot">&lt;-</span> p1_serving_tib <span class="sc">|&gt;</span> <span class="fu">pmap</span>(in_match_win, <span class="at">bestof3 =</span> best_of_3,</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">advantage =</span> advantage)</span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add probability to player 1 serving df</span></span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>    p1_serving_tib<span class="sc">$</span>probability <span class="ot">&lt;-</span> <span class="fu">unlist</span>(p1_win_prob)</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create id for each point (should be 4000 rows for one point)</span></span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>    p1_serving_tib <span class="ot">&lt;-</span> p1_serving_tib <span class="sc">|&gt;</span></span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p1_serv), <span class="at">each =</span> <span class="dv">4000</span>))</span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a>    p1_win_prob <span class="ot">&lt;-</span> p1_serving_tib <span class="sc">|&gt;</span> <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">mean_prob =</span> <span class="fu">mean</span>(probability)) <span class="sc">|&gt;</span></span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(mean_prob)</span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>    p1_serv<span class="sc">$</span>probability <span class="ot">&lt;-</span> p1_win_prob</span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a>    <span class="do">## number of rows should be number of server1 points times 4000</span></span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a>    p2_serving_tib <span class="ot">&lt;-</span> p2_serving_tib <span class="sc">|&gt;</span></span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(server.prob, returner.prob) <span class="sc">|&gt;</span></span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">server.prob =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>,</span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>             <span class="at">returner.prob =</span> <span class="st">`</span><span class="at">(Intercept)1</span><span class="st">`</span>)</span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate probability of player 1 winning throughout the match</span></span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a>    p2_win_prob <span class="ot">&lt;-</span> p2_serving_tib <span class="sc">|&gt;</span> <span class="fu">pmap</span>(in_match_win, <span class="at">bestof3 =</span> best_of_3,</span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">advantage =</span> advantage)</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add probability to player 1 serving df</span></span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a>    p2_serving_tib<span class="sc">$</span>probability <span class="ot">&lt;-</span> <span class="fu">unlist</span>(p2_win_prob)</span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create id for each point (should be 4000 rows for one point)</span></span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a>    p2_serving_tib <span class="ot">&lt;-</span> p2_serving_tib <span class="sc">|&gt;</span></span>
<span id="cb54-123"><a href="#cb54-123" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(p2_serv), <span class="at">each =</span> <span class="dv">4000</span>))</span>
<span id="cb54-124"><a href="#cb54-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a>    p2_win_prob <span class="ot">&lt;-</span> p2_serving_tib <span class="sc">|&gt;</span> <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span></span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">mean_prob =</span> <span class="fu">mean</span>(probability)) <span class="sc">|&gt;</span></span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pull</span>(mean_prob)</span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>    p2_serv<span class="sc">$</span>probability <span class="ot">&lt;-</span> p2_win_prob</span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># combine the data frames</span></span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a>  recombined_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(p2_serv, p1_serv) <span class="sc">|&gt;</span></span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(pt_number) <span class="sc">|&gt;</span></span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">total_sets =</span> <span class="fu">as.factor</span>(P1SetsWon <span class="sc">+</span> P2SetsWon)) <span class="sc">|&gt;</span></span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create probability var for just player 1 winning</span></span>
<span id="cb54-138"><a href="#cb54-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">win_prob_px =</span> <span class="fu">ifelse</span>(PointServer <span class="sc">==</span> which_player_prob, </span>
<span id="cb54-139"><a href="#cb54-139" aria-hidden="true" tabindex="-1"></a>                                probability, </span>
<span id="cb54-140"><a href="#cb54-140" aria-hidden="true" tabindex="-1"></a>                                <span class="dv">1</span> <span class="sc">-</span> probability))</span>
<span id="cb54-141"><a href="#cb54-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb54-142"><a href="#cb54-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(recombined_df)</span>
<span id="cb54-143"><a href="#cb54-143" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>