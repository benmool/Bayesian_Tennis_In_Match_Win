---
title: "WTA_data"
author: "Ben Moolman"
date: "2023-11-01"
output: html_document
---

```{r}
library(tidyverse)
library(readr)
library(deuce)
library(purrr)
```

Get csv for match data
```{r}
auso11 <- read_csv("2011-ausopen-points.csv")
```

Select one match from the data (Francesca Schiavone def Svetlana Kuznetsova 6-4, 1-6, 16-14)
```{r}
# select the single match
ausopen_2011_df <- auso11 |>
  filter(match_id == "2011-ausopen-2402") |>
  # now use SetWinner variable to change P1GamesWon and P2GamesWon to 0 for these rows
  mutate(P1GamesWon = ifelse(SetWinner != 0, 0, P1GamesWon),
         P2GamesWon = ifelse(SetWinner != 0, 0, P2GamesWon))

# check to see if P1GamesWon and P2GamesWon are 0 for all rows where SetWinner != 0
ausopen_2011_df |> filter(SetWinner != 0)
```

NOTE: Player 1 is Kuznetsova and Player 2 is Schiavone.

Select the columns that we need, and alter the P1Score and P2Score variables using case_when
```{r}
auso_condensed <- ausopen_2011_df |>
  select(PointWinner,
         P1Score,
         P2Score,
         P1GamesWon,
         P2GamesWon,
         SetWinner,
         PointServer) |>
  mutate(P1Score = ifelse(P1Score == "AD", 4, P1Score),
         P2Score = ifelse(P2Score == "AD", 4, P2Score),
         P1PointsWon = as.numeric(P1Score),
         P2PointsWon = as.numeric(P2Score)) |>
  mutate(P1PointsWon = case_when(P1Score == 0 ~ 0,
                                 P1Score == 15 ~ 1,
                                 P1Score == 30 ~ 2,
                                 P1Score == 40 ~ 3,
                                 TRUE ~ P1PointsWon),
         P2PointsWon = case_when(P2Score == 0 ~ 0,
                                 P2Score == 15 ~ 1,
                                 P2Score == 30 ~ 2,
                                 P2Score == 40 ~ 3,
                                 TRUE ~ P2PointsWon)) |>
  mutate(pt_number = row_number())
```

Make a data.frame with 8 columns, n_point rows, each column corresponds to an argument in the function above
```{r}
# make the dataframe
df <- tibble(
    p1_pts = auso_condensed$P1PointsWon,
    p2_pts = auso_condensed$P2PointsWon,
    p1_games = auso_condensed$P1GamesWon,
    p2_games = auso_condensed$P2GamesWon,
    p1_sets = cumsum(auso_condensed$SetWinner == 1),
    p2_sets = cumsum(auso_condensed$SetWinner == 2),
    server_prob = 0.52,
    returner_prob = 0.48,
    server = auso_condensed$PointServer,
    pt_number = auso_condensed$pt_number)
# split the df for each player serving
kuznetsova_serving <- df |>
  filter(server == 1)
schiavone_serving <- df |>
  filter(server == 2)
```

Kuznetsova serving df
```{r}
kuznetsova_serving_f <- tibble(
  point_a = kuznetsova_serving$p1_pts,
  point_b = kuznetsova_serving$p2_pts,
  game_a = kuznetsova_serving$p1_games,
  game_b = kuznetsova_serving$p2_games,
  set_a = kuznetsova_serving$p1_sets,
  set_b = kuznetsova_serving$p2_sets,
  server.prob = kuznetsova_serving$server_prob,
  returner.prob = kuznetsova_serving$returner_prob)
  
# calculate probability of kuznetsova winning throughout the match
kuznetsova_serve_prob <- kuznetsova_serving_f |> pmap(in_match_win, bestof3 = TRUE,
                   advantage = TRUE)

# add probability to kuznetsova_serving df
kuznetsova_serving$probability <- kuznetsova_serve_prob

# fix the probability column
kuznetsova_serving <- kuznetsova_serving |> unnest(probability)
```

Schiavone serving df
```{r}
# create df with schiavone serving
schiavone_serving_f <- tibble(
  point_a = schiavone_serving$p2_pts,
  point_b = schiavone_serving$p1_pts,
  game_a = schiavone_serving$p2_games,
  game_b = schiavone_serving$p1_games,
  set_a = schiavone_serving$p2_sets,
  set_b = schiavone_serving$p1_sets,
  server.prob = schiavone_serving$server_prob,
  returner.prob = schiavone_serving$returner_prob)

# calculate probability of schiavone winning throughout the match
schiavone_serve_prob <- schiavone_serving_f |> pmap(in_match_win, bestof3 = TRUE,
                   advantage = TRUE)

# add probability to schiavone df
schiavone_serving$probability <- schiavone_serve_prob

# fix the probability column
schiavone_serving <- schiavone_serving |> unnest(probability)
```

Combine the two data.frames
```{r}
# combine the two data.frames
recombined_auso <- rbind(kuznetsova_serving, schiavone_serving) |> 
  arrange(pt_number)
```

Plot the probability of winning the match for each player
```{r}
# change server variable to player name
recombined_auso$server <- ifelse(recombined_auso$server == 1, "Kuznetsova", "Schiavone")

# convert the server column to a factor
recombined_auso$server <- factor(recombined_auso$server)

library(ggplot2)

# plot the probability of winning the match for each player
recombined_auso |> ggplot(aes(x = pt_number, y = probability, color = server)) +
  geom_line() +
  scale_color_manual(values = c("red", "blue")) +
  labs(x = "Point Number",
       y = "Probability of Winning Match",
       title = "Schiavone vs Kuznetsova Australian Open 2011 Fourth Round",
       subtitle = "Probability of Winning Match for Each Player",
       color = "Server") +
  theme_bw()
```

```




