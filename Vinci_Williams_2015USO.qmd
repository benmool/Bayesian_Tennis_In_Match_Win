---
title: "Vinci_Williams2015USO"
format: html
---

```{r}
#| output: false
library(tidyverse)
library(compr)
library(broom)
library(dplyr)
library(readr)
library(deuce)
library(ggplot2)

# Source the functions
source("comp_prior_start.R")
source("bayes_intro.R")
source("wrangle_point_level_data.R")
source("Create_Prior.R")
source("get_probabilities_df.R")
source("get_plot_df.R")
```

We are going to look at the Williams vs Vinci 2015 US Open Semifinal match. Vinci defeated Williams in 3 sets: 2-6, 6-4, 6-4. We are going to mess around with the prior distribution and see how it changes the predicted win probabilities throughout the match:

  1. First, we will use a prior distribution that includes all hard court matches over the last year, including the 2014 US Open, and all matches of the 2015 US Open prior to the Semifinals.

  2. Then, we will use a prior distribution that only includes hard court matches from the "lead-up" tournaments to the 2015 US Open and the 2015 US Open itself (matches prior to the Semifinals).

  3. Lastly, we will use a prior distribution that has fixed probabilities for both players and does not update throughout the course of the match.
  
#### 1. Using 2014 US Open and 2015 US Open prior to the Quarterfinals and all matches in between
  
Get probabilities of Serena Williams winning a point while serving and while returning
```{r}
aug_mod_williams_large_prior <- create_prior(ext = c("wta_matches_2014.csv",
                                 "wta_matches_2015.csv"),
                         tourn_name = "US Open",
                         surf = "Hard",
                         start_date = "2014-08-25",
                         end_date = "2015-09-10",
                         player1 = "Serena Williams",
                         player2 = "Roberta Vinci",
                         ref_player = "Venus Williams")
# Note that output is always looking at P1 probability
aug_mod_williams_large_prior

# probability Williams wins a point on serve
expit(0.72131759) # 0.6728971
# probability Williams wins a point on return
expit(-0.03623523) # 0.4909422

# Do negation for Vinci points
# probability Vinci wins a point on serve
expit(0.03623523) # 0.5090578
# probability Vinci wins a point on return
expit(-0.72131759) # 0.3271029
```

Get the point level data for the 2015 US Open Semifinal match between Williams and Vinci
```{r}
both_serving_df <- wrangle_point_level(ext = "2015-usopen-points.csv",
                               ID = "2015-usopen-2601")

williams_serving <- both_serving_df[[1]]
vinci_serving <- both_serving_df[[2]]
```

Get a data frame with the probabilities for each player seving
```{r}
combined_prob_will_vinc_lp_df <- get_probabilities_df(p1_serving_df = williams_serving,
                                 p2_serving_df = vinci_serving,
                                 p1 = "Serena Williams",
                                 p2 = "Roberta Vinci",
                                 p1_original_prob = 0.72131759,
                                 p1_original_se = 0.06254039,
                                 p2_original_prob = 0.03623523,
                                 p2_original_se = 0.05988311)
```

Now we can plot the probability of Roberta Vinci winning the match
```{r}
plot_will_vinc_large_prior <- get_plot_df(combined_df = combined_prob_will_vinc_lp_df,
                                        which_player_prob = 2,
                                        best_of_3 = TRUE,
                                        advantage = FALSE)

set_boundaries_will_vinc_large_prior <- plot_will_vinc_large_prior |>
  group_by(total_sets) |>
  summarize(xmin = min(pt_number) - 0.5,
            xmax = max(pt_number) + 0.5)

plot_will_vinc_large_prior |> ggplot(aes(x = pt_number, y = probability)) +
  geom_rect(data = set_boundaries_will_vinc_large_prior, aes(x = NULL, y = NULL, xmin = xmin, xmax = xmax, 
                                       ymin = -Inf, ymax = Inf, fill = total_sets), alpha = 0.2) + 
  geom_line(aes(y = win_prob_px)) +
  labs(x = "Point Number",
       y = "Probability of Winning Match",
       title = "Williams vs Vinci US Open Semifinal 2015",
       subtitle = "Probability of Vinci Winning Match",
       caption = "Prior contains all hard court tournaments over the last year (incl. 2014 USO)",
       color = "Server") +
  coord_cartesian(ylim = c(0, NA)) +
  theme_bw()
```

#### 2. Using only the "lead-up" tournaments to the 2015 US Open and the 2015 US Open itself

Get probabilities of Serena Williams winning a point while serving and while returning
```{r}
aug_mod_williams_small_prior <- create_prior(ext = c("wta_matches_2014.csv",
                                 "wta_matches_2015.csv"),
                         tourn_name = "US Open",
                         surf = "Hard",
                         start_date = "2015-08-20",
                         end_date = "2015-09-10",
                         player1 = "Serena Williams",
                         player2 = "Roberta Vinci",
                         ref_player = "Venus Williams")
# Note that output is always looking at P1 probability
aug_mod_williams_small_prior

# probability Williams wins a point on serve
expit(0.72131759) # 0.6728971
# probability Williams wins a point on return
expit(-0.03623523) # 0.4909422

# Do negation for Vinci points
# probability Vinci wins a point on serve
expit(0.03623523) # 0.5090578
# probability Vinci wins a point on return
expit(-0.72131759) # 0.3271029
```

Get the point level data for the 2015 US Open Semifinal match between Williams and Vinci
```{r}
both_serving_df <- wrangle_point_level(ext = "2015-usopen-points.csv",
                               ID = "2015-usopen-2601")

williams_serving <- both_serving_df[[1]]
vinci_serving <- both_serving_df[[2]]
```

Get a data frame with the probabilities for each player seving
```{r}
combined_prob_will_vinc_lp_df <- get_probabilities_df(p1_serving_df = williams_serving,
                                 p2_serving_df = vinci_serving,
                                 p1 = "Serena Williams",
                                 p2 = "Roberta Vinci",
                                 p1_original_prob = 0.72131759,
                                 p1_original_se = 0.06254039,
                                 p2_original_prob = 0.03623523,
                                 p2_original_se = 0.05988311)
```

Now we can plot the probability of Roberta Vinci winning the match
```{r}
plot_will_vinc_large_prior <- get_plot_df(combined_df = combined_prob_will_vinc_lp_df,
                                        which_player_prob = 2,
                                        best_of_3 = TRUE,
                                        advantage = FALSE)

set_boundaries_will_vinc_large_prior <- plot_will_vinc_large_prior |>
  group_by(total_sets) |>
  summarize(xmin = min(pt_number) - 0.5,
            xmax = max(pt_number) + 0.5)

plot_will_vinc_large_prior |> ggplot(aes(x = pt_number, y = probability)) +
  geom_rect(data = set_boundaries_will_vinc_large_prior, aes(x = NULL, y = NULL, xmin = xmin, xmax = xmax, 
                                       ymin = -Inf, ymax = Inf, fill = total_sets), alpha = 0.2) + 
  geom_line(aes(y = win_prob_px)) +
  labs(x = "Point Number",
       y = "Probability of Winning Match",
       title = "Williams vs Vinci US Open Semifinal 2015",
       subtitle = "Probability of Vinci Winning Match",
       caption = "Prior contains all hard court tournaments over the last year (incl. 2014 USO)",
       color = "Server") +
  coord_cartesian(ylim = c(0, NA)) +
  theme_bw()
```
